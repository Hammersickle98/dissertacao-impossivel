<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel da Pr√°xis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos para a fonte Inter e cores tem√°ticas */
        body { font-family: 'Inter', sans-serif; }
        :root {
            --color-primary-light: #10B981; /* Verde */
            --color-secondary-light: #8B5CF6; /* Roxo */
            --color-primary-dark: #34D399;
            --color-secondary-dark: #A78BFA;
        }
        .bg-primary { background-color: var(--color-primary-light); }
        .text-primary { color: var(--color-primary-light); }
        .border-primary { border-color: var(--color-primary-light); }
        .bg-secondary { background-color: var(--color-secondary-light); }
        .text-secondary { color: var(--color-secondary-light); }
        .dark .bg-primary { background-color: var(--color-primary-dark); }
        .dark .text-primary { color: var(--color-primary-dark); }
        .dark .border-primary { border-color: var(--color-primary-dark); }
        .dark .bg-secondary { background-color: var(--color-secondary-dark); }
        .dark .text-secondary { color: var(--color-secondary-dark); }

        /* Anima√ß√£o para notifica√ß√µes */
        @keyframes slideInDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slideOutUp {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-100%); opacity: 0; }
        }
        .notification-enter { animation: slideInDown 0.5s ease-out forwards; }
        .notification-exit { animation: slideOutUp 0.5s ease-in forwards; }
        
        /* Estilo para scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px;}
        .dark ::-webkit-scrollbar-thumb { background: #555; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #777; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <!-- Container Principal -->
    <div id="app-container" class="max-w-4xl mx-auto p-4 pb-24 min-h-screen">

        <!-- Header -->
        <header class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-primary">Painel da Pr√°xis</h1>
            <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                <!-- √çcone de Lua/Sol -->
                <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            </button>
        </header>
        
        <!-- Abas de Conte√∫do -->
        <main>
            <!-- Aba 1: Pr√°xis Di√°ria -->
            <div id="tab-praxis" class="space-y-6">
                <!-- Conte√∫do gerado por JS -->
            </div>

            <!-- Aba 2: A Busca pela Totalidade -->
            <div id="tab-totalidade" class="hidden space-y-6">
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-2">A Busca pela Totalidade</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">A estrutura da disserta√ß√£o √© o mapa para um todo coerente. Conquiste cada parte.</p>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 mb-4">
                        <div id="total-progress-bar" class="bg-primary h-4 rounded-full transition-all duration-500" style="width: 0%;"></div>
                    </div>
                    <div id="dissertation-structure" class="space-y-2">
                        <!-- Estrutura gerada por JS -->
                    </div>
                    <button id="save-totalidade-btn" class="mt-6 w-full bg-primary text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 transition-opacity">
                        Salvar Progresso e Consolidar a Luta
                    </button>
                </div>
            </div>

            <!-- Aba 3: Balan√ßo Hist√≥rico -->
            <div id="tab-balanco" class="hidden space-y-6">
                 <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-2">Balan√ßo Hist√≥rico da Luta</h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Analise seus avan√ßos, entenda as contradi√ß√µes e planeje os pr√≥ximos passos.</p>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Registro Semanal -->
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                        <h3 class="font-bold mb-4">Registro Semanal da Pr√°xis</h3>
                        <div id="weekly-record" class="grid grid-cols-7 gap-2 text-center text-xs">
                            <!-- Dias da semana gerados por JS -->
                        </div>
                    </div>

                    <!-- Pontua√ß√£o -->
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                        <h3 class="font-bold mb-4">Sistema de Pontua√ß√£o</h3>
                        <div class="flex justify-around text-center">
                            <div>
                                <p class="text-gray-500 dark:text-gray-400">Pontos do Dia</p>
                                <p id="score-today" class="text-2xl font-bold text-primary">0</p>
                            </div>
                            <div>
                                <p class="text-gray-500 dark:text-gray-400">Total da Semana</p>
                                <p id="score-week" class="text-2xl font-bold text-secondary">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gr√°fico de Palavras -->
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                    <h3 class="font-bold mb-4">Evolu√ß√£o da Produ√ß√£o Material (Palavras)</h3>
                    <canvas id="word-count-chart"></canvas>
                </div>

                <!-- Painel de Conquistas -->
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                    <h3 class="font-bold mb-4">Mural de Trof√©us da Jornada</h3>
                    <div id="achievements-gallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                        <!-- Conquistas geradas por JS -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Barra de Navega√ß√£o Fixa -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 shadow-lg">
        <div class="max-w-4xl mx-auto flex justify-around">
            <button data-tab="praxis" class="nav-btn flex-1 p-3 text-center text-primary border-t-4 border-primary">
                <span class="text-xs sm:text-sm">Pr√°xis Di√°ria</span>
            </button>
            <button data-tab="totalidade" class="nav-btn flex-1 p-3 text-center text-gray-500 dark:text-gray-400 border-t-4 border-transparent">
                <span class="text-xs sm:text-sm">Totalidade</span>
            </button>
            <button data-tab="balanco" class="nav-btn flex-1 p-3 text-center text-gray-500 dark:text-gray-400 border-t-4 border-transparent">
                <span class="text-xs sm:text-sm">Balan√ßo</span>
            </button>
        </div>
    </nav>
    
    <!-- Container de Notifica√ß√µes -->
    <div id="notification-container" class="fixed top-0 left-1/2 -translate-x-1/2 w-full max-w-md p-4 z-50">
        <!-- Notifica√ß√µes geradas por JS -->
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Namespace do App
        const App = {
            // Elementos da UI
            ui: {
                container: document.getElementById('app-container'),
                tabs: {
                    praxis: document.getElementById('tab-praxis'),
                    totalidade: document.getElementById('tab-totalidade'),
                    balanco: document.getElementById('tab-balanco'),
                },
                navButtons: document.querySelectorAll('.nav-btn'),
                theme: {
                    toggle: document.getElementById('theme-toggle'),
                    iconLight: document.getElementById('theme-icon-light'),
                    iconDark: document.getElementById('theme-icon-dark'),
                },
                totalidade: {
                    structureContainer: document.getElementById('dissertation-structure'),
                    totalProgressBar: document.getElementById('total-progress-bar'),
                    saveButton: document.getElementById('save-totalidade-btn'),
                },
                balanco: {
                    weeklyRecord: document.getElementById('weekly-record'),
                    scoreToday: document.getElementById('score-today'),
                    scoreWeek: document.getElementById('score-week'),
                    wordChartCanvas: document.getElementById('word-count-chart'),
                    achievementsGallery: document.getElementById('achievements-gallery'),
                },
                notifications: {
                    container: document.getElementById('notification-container'),
                }
            },

            // Estado da Aplica√ß√£o
            state: {},

            // Fila de notifica√ß√µes
            notificationQueue: [],
            isNotifying: false,
            
            // Inst√¢ncia do Gr√°fico
            wordChart: null,

            // Inicializa√ß√£o
            init() {
                this.loadState();
                this.initTheme();
                this.initNavigation();
                this.renderAll();
                this.ui.totalidade.saveButton.addEventListener('click', () => this.handleTotalidadeSave());
            },

            // --- Gerenciamento de Estado ---
            getInitialState() {
                return {
                    theme: 'light',
                    dissertation: {
                        title: "ALIENA√á√ÉO, TOTALIDADE E HIST√ìRIA: A RECEP√á√ÉO DE GY√ñRGY LUK√ÅCS NO BRASIL A PARTIR DE LEANDRO KONDER E CARLOS NELSON COUTINHO (1961-1972)",
                        structure: [
                            { id: 'intro', title: 'Introdu√ß√£o', completed: false, children: [] },
                            { id: 'cap1', title: 'Cap√≠tulo 1: Aliena√ß√£o, totalidade e hist√≥ria como categorias centrais do pensamento lukacsiano', completed: false, children: [
                                { id: 'cap1.1', title: 'Subcap√≠tulo 1.1: Hist√≥ria e consci√™ncia de classe como um caminho para Marx: a concep√ß√£o da totalidade no ‚Äúmarxismo ortodoxo‚Äù e a reifica√ß√£o', completed: false },
                                { id: 'cap1.2', title: 'Subcap√≠tulo 1.2: Autocr√≠ticas e inflex√µes: o "tertium datur" entre o irracionalismo e o dogmatismo', completed: false },
                                { id: 'cap1.3', title: 'Subcap√≠tulo 1.3: O marxismo como Weltanschauung: est√©tica, √©tica e ontologia', completed: false },
                            ]},
                            { id: 'cap2', title: 'Cap√≠tulo 2: A forma√ß√£o do pensamento lukacsiano brasileiro', completed: false, children: [
                                { id: 'cap2.1', title: 'Subcap√≠tulo 2.1: A descoberta de Luk√°cs e as contradi√ß√µes da pol√≠tica cultural comunista', completed: false },
                                { id: 'cap2.2', title: 'Subcap√≠tulo 2.2: O surgimento do ‚Äúlukacsianismo brasileiro‚Äù', completed: false },
                                { id: 'cap2.3', title: 'Subcap√≠tulo 2.3: O lukacsianismo brasileiro em duas vertentes: os comunistas no Rio e o grupo ‚ÄúPr√°xis‚Äù de S√£o Paulo', completed: false },
                                { id: 'cap2.4', title: 'Subcap√≠tulo 2.4: A luta te√≥rico-ideol√≥gica por uma nova pol√≠tica cultural comunista', completed: false },
                            ]},
                            { id: 'cap3', title: 'Cap√≠tulo 3: O di√°logo com o mestre e a evolu√ß√£o do lukacsianismo de Konder e Coutinho (1960-1974)', completed: false, children: [
                                { id: 'cap3.1', title: 'Subcap√≠tulo 3.1: A correspond√™ncia como meio de forma√ß√£o do lukacsianismo brasileiro', completed: false },
                                { id: 'cap3.2', title: 'Subcap√≠tulo 3.2: Leandro Konder: aliena√ß√£o, realismo e a busca pelo marxismo aut√™ntico', completed: false },
                                { id: 'cap3.3', title: 'Subcap√≠tulo 3.3: Carlos Nelson Coutinho: entre o ‚Äúhistoricismo‚Äù e a dial√©tica objetiva', completed: false },
                            ]},
                            { id: 'conclusoes', title: 'Considera√ß√µes finais', completed: false, children: [] },
                            { id: 'referencias', title: 'Refer√™ncias', completed: false, children: [] },
                            { id: 'anexos', title: 'Anexos', completed: false, children: [] },
                        ]
                    },
                    praxisLog: {}, // { 'YYYY-MM-DD': { tasks: {id: bool}, words: number, score: number, saved: true } }
                    wordHistory: [], // { date: 'YYYY-MM-DD', totalWords: number }
                    achievements: this.getInitialAchievements(),
                };
            },

            loadState() {
                try {
                    const savedState = localStorage.getItem('praxisPainelState');
                    this.state = savedState ? JSON.parse(savedState) : this.getInitialState();
                    // Garante que a estrutura de conquistas est√° atualizada
                    const initialAchievements = this.getInitialAchievements();
                    for (const key in initialAchievements) {
                        if (!this.state.achievements[key]) {
                            this.state.achievements[key] = initialAchievements[key];
                        }
                    }
                } catch (error) {
                    console.error("Erro ao carregar o estado:", error);
                    this.state = this.getInitialState();
                }
            },

            saveState() {
                try {
                    localStorage.setItem('praxisPainelState', JSON.stringify(this.state));
                } catch (error) {
                    console.error("Erro ao salvar o estado:", error);
                    this.showNotification('Erro', 'N√£o foi poss√≠vel salvar os dados. O armazenamento pode estar cheio.', 'error');
                }
            },

            // --- Renderiza√ß√£o ---
            renderAll() {
                this.renderPraxis();
                this.renderTotalidade();
                this.renderBalanco();
            },

            // --- Tema ---
            initTheme() {
                this.ui.theme.toggle.addEventListener('click', () => {
                    this.state.theme = this.state.theme === 'light' ? 'dark' : 'light';
                    this.applyTheme();
                    this.saveState();
                });
                this.applyTheme();
            },

            applyTheme() {
                if (this.state.theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    this.ui.theme.iconLight.classList.add('hidden');
                    this.ui.theme.iconDark.classList.remove('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    this.ui.theme.iconLight.classList.remove('hidden');
                    this.ui.theme.iconDark.classList.add('hidden');
                }
                // Recarregar o gr√°fico para aplicar as cores do tema
                if (this.wordChart) {
                    this.wordChart.destroy();
                    this.renderWordChart();
                }
            },

            // --- Navega√ß√£o ---
            initNavigation() {
                this.ui.navButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const tabId = button.dataset.tab;
                        this.showTab(tabId);
                    });
                });
            },

            showTab(tabId) {
                Object.values(this.ui.tabs).forEach(tab => tab.classList.add('hidden'));
                this.ui.tabs[tabId].classList.remove('hidden');

                this.ui.navButtons.forEach(btn => {
                    if (btn.dataset.tab === tabId) {
                        btn.classList.add('text-primary', 'border-primary');
                        btn.classList.remove('text-gray-500', 'dark:text-gray-400', 'border-transparent');
                    } else {
                        btn.classList.remove('text-primary', 'border-primary');
                        btn.classList.add('text-gray-500', 'dark:text-gray-400', 'border-transparent');
                    }
                });
                // Renderiza o balan√ßo apenas quando a aba √© aberta para garantir que o gr√°fico seja vis√≠vel
                if (tabId === 'balanco') {
                    this.renderBalanco();
                }
            },

            // --- Aba: Pr√°xis Di√°ria ---
            renderPraxis() {
                const container = this.ui.tabs.praxis;
                const today = new Date();
                const dayOfWeek = today.getDay(); // 0 = Domingo, 1 = Segunda, ..., 6 = S√°bado
                const todayKey = today.toISOString().split('T')[0];
                const todayData = this.state.praxisLog[todayKey] || { tasks: {}, words: 0, score: 0, saved: false };

                let content = '';

                if (todayData.saved) {
                    content = `
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow text-center">
                            <h2 class="text-xl font-bold text-primary mb-2">Pr√°xis do Dia Conclu√≠da!</h2>
                            <p class="text-gray-600 dark:text-gray-400 mb-4">A luta de hoje foi registrada. Descanse e prepare-se para o pr√≥ximo dia. A revolu√ß√£o n√£o para!</p>
                            <button id="edit-praxis-btn" class="bg-secondary text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 transition-opacity">Fazer Altera√ß√µes</button>
                        </div>
                    `;
                } else {
                    let tasksHtml = '';
                    const tasks = this.getTasksForDay(dayOfWeek);

                    tasks.forEach(task => {
                        tasksHtml += `
                            <label for="task-${task.id}" class="flex items-center p-4 border border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                                <input type="checkbox" id="task-${task.id}" data-id="${task.id}" data-points="${task.points}" class="praxis-task h-5 w-5 rounded text-primary focus:ring-primary">
                                <span class="ml-4 flex-grow">
                                    <span class="font-bold">${task.name}</span>
                                    <span class="text-sm text-secondary"> (+${task.points} pts)</span>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">${task.desc}</p>
                                </span>
                            </label>
                        `;
                    });

                    if (dayOfWeek === 0) { // Domingo
                        tasksHtml += `
                            <div class="text-center p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                                <p class="mb-4">Domingo √© dia de descanso e reflex√£o. Recupere as energias.</p>
                                <button id="sunday-extra-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Preciso Avan√ßar</button>
                            </div>
                            <div id="sunday-extra-task" class="hidden">
                                ${this.getTasksForDay(-1).map(task => `
                                    <label for="task-${task.id}" class="flex items-center p-4 border border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                                        <input type="checkbox" id="task-${task.id}" data-id="${task.id}" data-points="${task.points}" class="praxis-task h-5 w-5 rounded text-secondary focus:ring-secondary">
                                        <span class="ml-4 flex-grow">
                                            <span class="font-bold text-secondary">${task.name}</span>
                                            <span class="text-sm text-purple-400"> (+${task.points} pts)</span>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">${task.desc}</p>
                                        </span>
                                    </label>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    content = `
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                            <h2 class="text-xl font-bold mb-2">Pr√°xis Di√°ria</h2>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Sua a√ß√£o transformadora no mundo. O que ser√° feito hoje?</p>
                            <div class="space-y-4">${tasksHtml}</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                            <h3 class="font-bold mb-2">Produ√ß√£o Material</h3>
                            <label for="word-count" class="text-sm text-gray-600 dark:text-gray-400">Palavras escritas hoje:</label>
                            <input type="number" id="word-count" min="0" value="0" class="mt-1 w-full p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                            <p class="text-sm mt-2 text-gray-500 dark:text-gray-400">Total Acumulado: <span id="total-word-count" class="font-bold">${this.calculateTotalWords()}</span></p>
                        </div>
                        <button id="save-praxis-btn" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg hover:opacity-90 transition-opacity text-lg">
                            Registrar Pr√°xis do Dia
                        </button>
                    `;
                }
                
                container.innerHTML = content;
                this.addPraxisListeners(todayData.saved);
            },

            getTasksForDay(dayOfWeek) {
                // dayOfWeek: -1 for Sunday extra, 0 for Sunday, 1-5 for Weekdays, 6 for Saturday
                const weekdaysTasks = [
                    { id: 'escrita', name: 'Escrita', points: 15, desc: 'Avan√ßar na reda√ß√£o da disserta√ß√£o.' },
                    { id: 'leitura', name: 'Leitura', points: 10, desc: 'Leitura e fichamento de textos.' },
                    { id: 'organizacao', name: 'Organiza√ß√£o', points: 5, desc: 'Organizar notas, refer√™ncias ou estrutura.' },
                ];
                const saturdayTasks = [
                    { id: 'revisao', name: 'Revis√£o Semanal', points: 10, desc: 'Revisar o que foi produzido na semana.' },
                    { id: 'planejamento', name: 'Planejamento Leve', points: 5, desc: 'Planejar as metas da pr√≥xima semana.' },
                ];
                const sundayExtraTask = [
                    { id: 'avanco', name: 'Avan√ßo Estrat√©gico', points: 25, desc: 'Um esfor√ßo extra para adiantar ou recuperar o trabalho.' },
                ];

                if (dayOfWeek >= 1 && dayOfWeek <= 5) return weekdaysTasks;
                if (dayOfWeek === 6) return saturdayTasks;
                if (dayOfWeek === -1) return sundayExtraTask; // Special case for button
                return []; // Sunday default
            },

            addPraxisListeners(isSaved) {
                if (isSaved) {
                    document.getElementById('edit-praxis-btn').addEventListener('click', () => {
                        const todayKey = new Date().toISOString().split('T')[0];
                        if (this.state.praxisLog[todayKey]) {
                            this.state.praxisLog[todayKey].saved = false;
                        }
                        this.renderPraxis();
                    });
                } else {
                    document.getElementById('save-praxis-btn').addEventListener('click', () => this.handlePraxisSave());
                    const sundayExtraBtn = document.getElementById('sunday-extra-btn');
                    if (sundayExtraBtn) {
                        sundayExtraBtn.addEventListener('click', () => {
                            document.getElementById('sunday-extra-task').classList.remove('hidden');
                            sundayExtraBtn.parentElement.classList.add('hidden');
                        });
                    }
                }
            },

            handlePraxisSave() {
                const todayKey = new Date().toISOString().split('T')[0];
                const tasks = {};
                let score = 0;
                document.querySelectorAll('.praxis-task:checked').forEach(taskEl => {
                    const id = taskEl.dataset.id;
                    const points = parseInt(taskEl.dataset.points, 10);
                    tasks[id] = true;
                    score += points;
                });

                const words = parseInt(document.getElementById('word-count').value, 10) || 0;

                this.state.praxisLog[todayKey] = { tasks, words, score, saved: true };

                // Atualiza hist√≥rico de palavras
                const existingEntryIndex = this.state.wordHistory.findIndex(e => e.date === todayKey);
                const totalWords = this.calculateTotalWords();
                if (existingEntryIndex > -1) {
                    this.state.wordHistory[existingEntryIndex].totalWords = totalWords;
                } else {
                    this.state.wordHistory.push({ date: todayKey, totalWords: totalWords });
                }
                // Ordenar hist√≥rico por data
                this.state.wordHistory.sort((a, b) => new Date(a.date) - new Date(b.date));


                this.checkAchievements();
                this.saveState();
                this.showNotification('Sucesso!', 'Sua pr√°xis di√°ria foi registrada.', 'success');
                this.renderPraxis();
                this.renderBalanco();
            },
            
            calculateTotalWords() {
                return Object.values(this.state.praxisLog).reduce((total, day) => total + (day.words || 0), 0);
            },

            // --- Aba: A Busca pela Totalidade ---
            renderTotalidade() {
                const container = this.ui.totalidade.structureContainer;
                container.innerHTML = ''; // Limpa a estrutura atual
                this.state.dissertation.structure.forEach((item, index) => {
                    container.appendChild(this.createStructureItem(item, [index]));
                });
                this.updateTotalProgress();
            },

            createStructureItem(item, path) {
                const itemDiv = document.createElement('div');
                itemDiv.className = `p-3 rounded-lg ${path.length > 1 ? 'ml-6 bg-gray-50 dark:bg-gray-700/50' : 'bg-white dark:bg-gray-800 shadow-sm'}`;
                
                const hasChildren = item.children && item.children.length > 0;
                let progressBarHtml = '';
                if (hasChildren) {
                    const progress = this.calculateChapterProgress(item);
                    progressBarHtml = `
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2.5 mt-2">
                            <div class="bg-secondary h-2.5 rounded-full" style="width: ${progress}%"></div>
                        </div>
                    `;
                }

                itemDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center flex-grow">
                            ${!hasChildren ? `
                            <button data-path="${path.join('.')}" class="toggle-complete-btn mr-3 flex-shrink-0 w-6 h-6 rounded border-2 ${item.completed ? 'bg-secondary border-secondary text-white' : 'border-gray-400'} flex items-center justify-center">
                                ‚úì
                            </button>
                            ` : `<div class="w-6 h-6 mr-3 flex-shrink-0"></div>`}
                            <span data-path="${path.join('.')}" class="item-title flex-grow font-medium ${item.completed ? 'line-through text-gray-500' : ''}">${item.title}</span>
                        </div>
                        <div class="flex-shrink-0 ml-2 space-x-2">
                            <button data-path="${path.join('.')}" class="add-item-btn text-blue-500 hover:text-blue-700 text-xl font-bold">+</button>
                            <button data-path="${path.join('.')}" class="delete-item-btn text-red-500 hover:text-red-700 text-xl font-bold">√ó</button>
                        </div>
                    </div>
                    ${progressBarHtml}
                `;

                if (hasChildren) {
                    const childrenContainer = document.createElement('div');
                    childrenContainer.className = 'mt-2 space-y-2';
                    item.children.forEach((child, index) => {
                        childrenContainer.appendChild(this.createStructureItem(child, [...path, index]));
                    });
                    itemDiv.appendChild(childrenContainer);
                }
                
                this.addStructureItemListeners(itemDiv, path);
                return itemDiv;
            },
            
            addStructureItemListeners(element, path) {
                // Editar t√≠tulo
                const titleEl = element.querySelector('.item-title');
                titleEl.addEventListener('dblclick', () => {
                    const currentTitle = titleEl.textContent;
                    titleEl.innerHTML = `<input type="text" class="w-full bg-gray-200 dark:bg-gray-600 p-1 rounded" value="${currentTitle}">`;
                    const input = titleEl.querySelector('input');
                    input.focus();
                    input.addEventListener('blur', () => this.updateItemTitle(path, input.value));
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') input.blur();
                    });
                });

                // Deletar item
                element.querySelector('.delete-item-btn').addEventListener('click', () => this.deleteItem(path));
                
                // Adicionar item
                element.querySelector('.add-item-btn').addEventListener('click', () => this.addItem(path));

                // Marcar como completo
                const completeBtn = element.querySelector('.toggle-complete-btn');
                if (completeBtn) {
                    completeBtn.addEventListener('click', () => this.toggleComplete(path));
                }
            },

            getItemByPath(path) {
                let item = { children: this.state.dissertation.structure };
                for (const index of path) {
                    if (!item.children || !item.children[index]) return null;
                    item = item.children[index];
                }
                return item;
            },
            
            getParentByPath(path) {
                if (path.length === 1) return { children: this.state.dissertation.structure };
                let parentPath = path.slice(0, -1);
                return this.getItemByPath(parentPath);
            },

            updateItemTitle(path, newTitle) {
                const item = this.getItemByPath(path);
                if (item) item.title = newTitle;
                this.renderTotalidade();
            },

            deleteItem(path) {
                if (confirm('Tem certeza que deseja excluir este item e todos os seus sub-itens? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    const parent = this.getParentByPath(path);
                    const index = path[path.length - 1];
                    if (parent && parent.children) {
                        parent.children.splice(index, 1);
                        this.renderTotalidade();
                    }
                }
            },

            addItem(path) {
                const parent = this.getItemByPath(path);
                if (parent) {
                    if (!parent.children) parent.children = [];
                    const newItemTitle = parent.children.length > 0 ? 'Novo Subcap√≠tulo' : 'Novo Cap√≠tulo';
                    parent.children.push({
                        id: 'custom-' + Date.now(),
                        title: newItemTitle,
                        completed: false
                    });
                    this.renderTotalidade();
                }
            },

            toggleComplete(path) {
                const item = this.getItemByPath(path);
                if (item) {
                    item.completed = !item.completed;
                    this.renderTotalidade();
                }
            },
            
            handleTotalidadeSave() {
                this.checkAchievements();
                this.saveState();
                this.showNotification('Progresso Salvo!', 'A estrutura da sua totalidade foi atualizada.', 'success');
            },
            
            calculateChapterProgress(chapter) {
                if (!chapter.children || chapter.children.length === 0) {
                    return chapter.completed ? 100 : 0;
                }
                const completedCount = chapter.children.filter(sub => sub.completed).length;
                return (completedCount / chapter.children.length) * 100;
            },

            updateTotalProgress() {
                const allItems = this.state.dissertation.structure.flatMap(item => {
                    return (item.children && item.children.length > 0) ? item.children : [item];
                });
                const completedItems = allItems.filter(item => item.completed);
                const progress = allItems.length > 0 ? (completedItems.length / allItems.length) * 100 : 0;
                this.ui.totalidade.totalProgressBar.style.width = `${progress}%`;
            },

            // --- Aba: Balan√ßo Hist√≥rico ---
            renderBalanco() {
                this.renderWeeklyRecord();
                this.renderScores();
                this.renderWordChart();
                this.renderAchievements();
            },

            renderWeeklyRecord() {
                const container = this.ui.balanco.weeklyRecord;
                container.innerHTML = '';
                const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
                const today = new Date();
                const dayOfWeek = today.getDay();
                
                for (let i = 0; i < 7; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - (dayOfWeek - i));
                    const dateKey = date.toISOString().split('T')[0];
                    const log = this.state.praxisLog[dateKey];
                    
                    let colorClass = 'bg-gray-200 dark:bg-gray-700';
                    if (log && log.saved) {
                        colorClass = 'bg-primary'; // Verde
                        if (log.tasks && log.tasks.avanco) {
                            colorClass = 'bg-secondary'; // Roxo
                        }
                    }

                    container.innerHTML += `
                        <div class="text-center">
                            <p class="font-semibold">${dayNames[i]}</p>
                            <div class="w-8 h-8 mx-auto mt-1 rounded ${colorClass}"></div>
                        </div>
                    `;
                }
            },
            
            renderScores() {
                const todayKey = new Date().toISOString().split('T')[0];
                const todayLog = this.state.praxisLog[todayKey];
                this.ui.balanco.scoreToday.textContent = (todayLog && todayLog.score) ? todayLog.score : 0;

                const today = new Date();
                const dayOfWeek = today.getDay();
                let weeklyScore = 0;
                for (let i = 0; i <= dayOfWeek; i++) {
                    const date = new Date();
                    date.setDate(today.getDate() - (dayOfWeek - i));
                    const dateKey = date.toISOString().split('T')[0];
                    const log = this.state.praxisLog[dateKey];
                    if (log && log.score) {
                        weeklyScore += log.score;
                    }
                }
                this.ui.balanco.scoreWeek.textContent = weeklyScore;
            },

            renderWordChart() {
                if (this.wordChart) {
                    this.wordChart.destroy();
                }
                const ctx = this.ui.balanco.wordChartCanvas.getContext('2d');
                const labels = this.state.wordHistory.map(e => e.date.substring(5)); // Formato MM-DD
                const data = this.state.wordHistory.map(e => e.totalWords);
                
                const isDark = this.state.theme === 'dark';
                const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                const fontColor = isDark ? '#E5E7EB' : '#1F2937';

                this.wordChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total de Palavras',
                            data: data,
                            borderColor: isDark ? '#A78BFA' : '#8B5CF6', // Roxo
                            backgroundColor: isDark ? 'rgba(167, 139, 250, 0.2)' : 'rgba(139, 92, 246, 0.2)',
                            tension: 0.1,
                            fill: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: fontColor },
                                grid: { color: gridColor }
                            },
                            x: {
                                ticks: { color: fontColor },
                                grid: { color: gridColor }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: fontColor }
                            }
                        }
                    }
                });
            },

            renderAchievements() {
                const container = this.ui.balanco.achievementsGallery;
                container.innerHTML = '';
                Object.values(this.state.achievements).forEach(ach => {
                    const unlocked = ach.unlocked;
                    container.innerHTML += `
                        <div class="p-3 rounded-lg text-center ${unlocked ? 'bg-green-100 dark:bg-green-900/50' : 'bg-gray-200 dark:bg-gray-700'}">
                            <div class="text-4xl mb-2">${unlocked ? 'üèÜ' : '‚ùì'}</div>
                            <h4 class="font-bold text-sm ${unlocked ? 'text-green-800 dark:text-green-300' : ''}">${ach.title}</h4>
                            <p class="text-xs text-gray-600 dark:text-gray-400">${ach.desc}</p>
                        </div>
                    `;
                });
            },
            
            // --- Sistema de Conquistas e Notifica√ß√µes ---
            getInitialAchievements() {
                return {
                    'start': { id: 'start', title: 'O In√≠cio da Luta', desc: 'Registrar a primeira pr√°xis di√°ria.', unlocked: false },
                    'words1k': { id: 'words1k', title: 'A Palavra como Arma', desc: 'Escrever um total de 1.000 palavras.', unlocked: false },
                    'words10k': { id: 'words10k', title: 'Manifesto Pessoal', desc: 'Escrever um total de 10.000 palavras.', unlocked: false },
                    'words50k': { id: 'words50k', title: 'O Capital (Pessoal)', desc: 'Escrever um total de 50.000 palavras.', unlocked: false },
                    'consistency3': { id: 'consistency3', title: 'Ritmo Constante', desc: 'Manter uma rotina de 3 dias na semana.', unlocked: false },
                    'consistency5': { id: 'consistency5', title: 'Ritmo Revolucion√°rio', desc: 'Manter uma rotina de 5 dias na semana.', unlocked: false },
                    'score100': { id: 'score100', title: 'Acumula√ß√£o Primitiva', desc: 'Alcan√ßar 100 pontos em uma semana.', unlocked: false },
                    'sunday_warrior': { id: 'sunday_warrior', title: 'Domingo Vermelho', desc: 'Usar a op√ß√£o "Preciso Avan√ßar" no domingo.', unlocked: false },
                    'intro_done': { id: 'intro_done', title: 'O Pref√°cio da Hist√≥ria', desc: 'Concluir a Introdu√ß√£o.', unlocked: false },
                    'cap1_done': { id: 'cap1_done', title: 'Consci√™ncia de Classe', desc: 'Concluir o Cap√≠tulo 1.', unlocked: false },
                    'cap2_done': { id: 'cap2_done', title: 'A Pr√°xis Brasileira', desc: 'Concluir o Cap√≠tulo 2.', unlocked: false },
                    'cap3_done': { id: 'cap3_done', title: 'Di√°logo com o Mestre', desc: 'Concluir o Cap√≠tulo 3.', unlocked: false },
                    'all_chapters_done': { id: 'all_chapters_done', title: 'A Totalidade em Vista', desc: 'Concluir todos os cap√≠tulos.', unlocked: false },
                    'dissertation_done': { id: 'dissertation_done', title: 'A Pr√°xis se Completa', desc: 'Concluir todos os itens da disserta√ß√£o.', unlocked: false },
                };
            },

            checkAchievements() {
                const achievements = this.state.achievements;
                
                // L√≥gica de verifica√ß√£o
                const check = (id, condition) => {
                    if (!achievements[id].unlocked && condition) {
                        achievements[id].unlocked = true;
                        this.showNotification(`üèÜ Conquista Desbloqueada!`, achievements[id].title, 'achievement');
                    }
                };
                
                // Verifica√ß√µes
                const logKeys = Object.keys(this.state.praxisLog);
                check('start', logKeys.length >= 1);

                const totalWords = this.calculateTotalWords();
                check('words1k', totalWords >= 1000);
                check('words10k', totalWords >= 10000);
                check('words50k', totalWords >= 50000);
                
                const weeklyScore = parseInt(this.ui.balanco.scoreWeek.textContent, 10);
                check('score100', weeklyScore >= 100);
                
                const todayKey = new Date().toISOString().split('T')[0];
                const todayLog = this.state.praxisLog[todayKey];
                if (todayLog && todayLog.tasks.avanco) {
                    check('sunday_warrior', true);
                }
                
                const daysThisWeek = this.getDaysThisWeek();
                const activeDays = daysThisWeek.filter(day => this.state.praxisLog[day] && this.state.praxisLog[day].saved).length;
                check('consistency3', activeDays >= 3);
                check('consistency5', activeDays >= 5);
                
                // Verifica√ß√µes de estrutura
                const intro = this.getItemByPath([0]);
                check('intro_done', intro && intro.completed);
                
                const cap1 = this.getItemByPath([1]);
                check('cap1_done', cap1 && this.isChapterComplete(cap1));

                const cap2 = this.getItemByPath([2]);
                check('cap2_done', cap2 && this.isChapterComplete(cap2));

                const cap3 = this.getItemByPath([3]);
                check('cap3_done', cap3 && this.isChapterComplete(cap3));

                const allChapters = this.state.dissertation.structure.filter(item => item.id.startsWith('cap'));
                check('all_chapters_done', allChapters.every(c => this.isChapterComplete(c)));
                
                const allItems = this.state.dissertation.structure.flatMap(item => (item.children && item.children.length > 0) ? item.children : [item]);
                check('dissertation_done', allItems.every(item => item.completed));
            },
            
            getDaysThisWeek() {
                const days = [];
                const today = new Date();
                const dayOfWeek = today.getDay();
                for (let i = 0; i < 7; i++) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - (dayOfWeek - i));
                    days.push(date.toISOString().split('T')[0]);
                }
                return days;
            },

            isChapterComplete(chapter) {
                if (!chapter.children || chapter.children.length === 0) return chapter.completed;
                return chapter.children.every(sub => sub.completed);
            },

            showNotification(title, message, type = 'info') {
                this.notificationQueue.push({ title, message, type });
                this.processNotificationQueue();
            },

            processNotificationQueue() {
                if (this.isNotifying || this.notificationQueue.length === 0) {
                    return;
                }
                this.isNotifying = true;
                const { title, message, type } = this.notificationQueue.shift();
                
                const notification = document.createElement('div');
                let colors = 'bg-blue-500 text-white';
                if (type === 'success') colors = 'bg-green-500 text-white';
                if (type === 'error') colors = 'bg-red-500 text-white';
                if (type === 'achievement') colors = 'bg-yellow-400 text-gray-800';

                notification.className = `p-4 rounded-lg shadow-xl ${colors} notification-enter`;
                notification.innerHTML = `
                    <h4 class="font-bold">${title}</h4>
                    <p>${message}</p>
                `;

                this.ui.notifications.container.appendChild(notification);

                setTimeout(() => {
                    notification.classList.remove('notification-enter');
                    notification.classList.add('notification-exit');
                    notification.addEventListener('animationend', () => {
                        notification.remove();
                        this.isNotifying = false;
                        this.processNotificationQueue();
                    });
                }, 5000);
            },
        };

        // Inicia a aplica√ß√£o
        App.init();
    });
    </script>
</body>
</html>

