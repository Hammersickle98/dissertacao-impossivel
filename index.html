<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel da Pr√°xis Acad√™mica v10.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #d1d5db; }
        .nav-button.active { background-color: #4f46e5; color: #ffffff; }
        .progress-bar-bg { background-color: #374151; }
        .progress-bar-fill { background-color: #4f46e5; transition: width 0.5s ease-in-out; }
        .chapter-progress-bar-fill { background-color: #16a34a; }
        .task-item:has(input:checked) .task-label, .subchapter-item.completed .editable, .chapter-item.completed .editable { text-decoration: line-through; color: #6b7280; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .hidden { display: none; }
        #achievement-toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background-color: #16a34a; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 100; transition: top 0.5s ease-in-out; text-align: center; }
        .delete-btn { opacity: 0.2; transition: opacity 0.2s; }
        .task-item:hover .delete-btn, .subchapter-title:hover .delete-btn, .chapter-header:hover .delete-btn { opacity: 1; }
        .focus-panel { transition: opacity 0.3s, transform 0.3s; }
        .achievement-card.locked { opacity: 0.4; filter: grayscale(80%); }
        .week-log-day-block { width: 12px; height: 12px; border-radius: 2px; }
    </style>
</head>
<body class="antialiased">

    <div id="achievement-toast"><h4 id="achievement-title" class="font-bold"></h4><p id="achievement-message" class="text-sm"></p></div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"><div class="bg-gray-800 rounded-lg p-6 shadow-xl max-w-sm mx-auto"><h3 id="modal-title" class="text-lg font-bold text-white">Confirmar A√ß√£o</h3><p id="modal-body" class="text-sm text-gray-300 mt-2 mb-4">Voc√™ tem certeza de que deseja excluir este item? Esta a√ß√£o √© irrevers√≠vel.</p><div class="flex justify-end space-x-4"><button id="modal-cancel" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600">Cancelar</button><button id="modal-confirm" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Excluir</button></div></div></div>
    <div id="focus-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"><div class="bg-gray-800 rounded-lg p-6 shadow-xl w-full max-w-md mx-auto"><h3 class="text-lg font-bold text-white">Compromisso com a Pr√°xis</h3><p class="text-sm text-gray-400 mt-2 mb-4">Defina sua tarefa imediata para esta sess√£o de foco.</p><div><label for="focus-goal-input" class="block text-sm font-medium text-gray-300">Qual √© a sua tarefa imediata, camarada?</label><input type="text" id="focus-goal-input" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="Ex: Escrever 250 palavras sobre a reifica√ß√£o..."></div><div class="mt-4"><p class="block text-sm font-medium text-gray-300">Qual a dura√ß√£o desta jornada?</p><div class="flex space-x-2 mt-2" id="focus-duration-options"><button data-duration="5400" class="flex-1 px-4 py-2 text-sm font-medium bg-purple-600 text-white rounded-md hover:bg-gray-600">90 min</button><button data-duration="7200" class="flex-1 px-4 py-2 text-sm font-medium bg-gray-700 rounded-md hover:bg-gray-600">120 min</button><button data-duration="10800" class="flex-1 px-4 py-2 text-sm font-medium bg-gray-700 rounded-md hover:bg-gray-600">180 min</button></div></div><div class="mt-4 flex items-center"><input id="focus-fullscreen-checkbox" type="checkbox" class="h-4 w-4 rounded bg-gray-600 border-gray-500 text-purple-500 focus:ring-purple-600"><label for="focus-fullscreen-checkbox" class="ml-2 block text-sm text-gray-300">Ativar Velo da Aliena√ß√£o (Modo Imersivo)</label></div><div class="mt-6 flex justify-end space-x-4"><button id="focus-modal-cancel" class="px-4 py-2 text-sm font-medium text-gray-300 bg-gray-700 rounded-md hover:bg-gray-600">Cancelar</button><button id="focus-modal-start" class="px-4 py-2 text-sm font-medium text-white bg-purple-600 rounded-md hover:bg-purple-700">Iniciar Foco</button></div></div></div>
    <div id="focus-panel" class="hidden fixed bottom-4 right-4 bg-gray-900/80 backdrop-blur-md border border-purple-500/50 rounded-lg p-4 w-80 shadow-2xl opacity-0 transform translate-y-4"><div class="flex items-center justify-between"><div class="flex-grow"><p class="text-xs text-purple-300">Foco Atual:</p><p id="focus-panel-goal" class="text-sm font-semibold text-white truncate"></p></div><div class="ml-4 text-right"><p class="text-xs text-gray-400">Tempo Restante:</p><p id="focus-panel-timer" class="text-2xl font-bold text-white"></p></div></div><div class="w-full bg-gray-700 rounded-full h-1 mt-2"><div id="focus-panel-progress" class="bg-purple-500 h-1 rounded-full" style="width: 100%;"></div></div><button id="focus-panel-stop" class="w-full mt-3 text-center text-xs text-red-400 hover:text-red-300">Abandonar a Pr√°xis (Parar)</button></div>
    <div id="sound-panel-container" class="fixed bottom-4 left-4 z-40"><button id="sound-panel-toggle" class="w-12 h-12 bg-gray-800 border border-gray-700 rounded-full flex items-center justify-center text-2xl shadow-lg">üéµ</button><div id="sound-panel" class="hidden absolute bottom-16 left-0 bg-gray-800/80 backdrop-blur-md border border-gray-700 rounded-lg p-3 space-y-2 w-64"><button data-sound="white-noise" class="sound-btn w-full text-left text-sm p-2 hover:bg-gray-700 rounded-md">Sil√™ncio de Budapeste (Ru√≠do Branco)</button><button data-sound="ocean-waves" class="sound-btn w-full text-left text-sm p-2 hover:bg-gray-700 rounded-md">Dial√©tica da Natureza (Ondas)</button><button data-sound="binaural" class="sound-btn w-full text-left text-sm p-2 hover:bg-gray-700 rounded-md">Foco Prolet√°rio (Binaural)</button><button data-sound="stop" class="w-full text-left text-sm p-2 text-red-400 hover:bg-gray-700 rounded-md">Parar</button></div></div>

    <div class="container mx-auto max-w-6xl p-4 sm:p-6 md:p-8">
        <header class="text-center mb-10 flex justify-between items-center"><div class="flex-1"></div><div class="flex-1"><h1 class="text-4xl font-bold text-white">Painel da Pr√°xis Acad√™mica</h1><p class="text-gray-400 mt-2">Pela supera√ß√£o da aliena√ß√£o, rumo √† totalidade concreta.</p></div><div class="flex-1 flex justify-end"><button id="fullscreen-btn" title="Ativar Modo Imersivo" class="text-2xl text-gray-500 hover:text-white transition">‚õ∂</button></div></header>
        <nav class="mb-8 flex justify-center bg-gray-800/50 backdrop-blur-sm p-2 rounded-lg border border-gray-700"><div id="nav-container" class="flex flex-wrap justify-center gap-2"><button data-target="praxis-diaria" class="nav-button active px-4 py-2 text-sm font-semibold rounded-md transition">Pr√°xis Di√°ria</button><button data-target="busca-totalidade" class="nav-button px-4 py-2 text-sm font-semibold rounded-md transition">A Busca pela Totalidade</button><button data-target="balanco-historico" class="nav-button px-4 py-2 text-sm font-semibold rounded-md transition">Balan√ßo Hist√≥rico</button></div></nav>
        <main>
            <section id="praxis-diaria" class="main-section"><div class="grid lg:grid-cols-3 gap-8"><div class="lg:col-span-2 bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700"><h2 class="text-2xl font-bold mb-4 text-white">Frente de Batalha: <span id="current-day"></span></h2><div id="daily-task-list" class="space-y-4"></div><div class="mt-8 pt-6 border-t border-gray-700 flex justify-between items-center"><button id="start-focus-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Engajar em Foco Total</button><button id="save-daily-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Salvar Pr√°xis do Dia</button></div></div><div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700"><h2 class="text-2xl font-bold mb-4 text-white">Produ√ß√£o Material</h2><p class="text-sm text-gray-400 mb-4">Registre a produ√ß√£o de palavras para a an√°lise da mais-valia (acad√™mica).</p><div class="mt-4 flex gap-2"><input type="number" id="word-count-input" class="w-full border bg-gray-700 border-gray-600 text-white rounded-md px-3 py-2 text-sm" placeholder="Palavras de hoje..."/><button id="add-progress-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md text-sm">Registrar</button></div><p class="text-sm text-gray-400 mt-4">Total Acumulado: <span id="total-word-count" class="font-bold text-purple-300">0</span> palavras</p></div></div></section>
            <section id="busca-totalidade" class="main-section hidden"><div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700"><h2 class="text-2xl font-bold mb-2 text-white">A Busca pela Totalidade</h2><p class="text-gray-400 mb-6">As etapas da revolu√ß√£o. Organize os momentos do processo dial√©tico.</p><div class="mb-8"><div class="flex justify-between items-center mb-1"><span class="text-sm font-medium text-purple-300">Consci√™ncia de Si da Disserta√ß√£o (Progresso Total)</span><span id="total-progress-text" class="text-sm font-medium text-purple-300">0%</span></div><div class="w-full progress-bar-bg rounded-full h-4"><div id="total-progress-bar" class="progress-bar-fill h-4 rounded-full"></div></div></div><div id="chapters-container" class="space-y-4"></div><div class="mt-6 pt-6 border-t border-gray-700 flex justify-between items-center"><input type="text" id="new-chapter-input" class="new-item-input bg-gray-700 border border-gray-600 text-sm rounded-md w-full p-2" placeholder="+ Adicionar novo cap√≠tulo ou se√ß√£o..."/><button id="save-manifesto-btn" class="ml-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg">Salvar Manifesto</button></div></div></section>
            <section id="balanco-historico" class="main-section hidden"><div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700"><h2 class="text-2xl font-bold mb-2 text-white">Balan√ßo Hist√≥rico da Consci√™ncia</h2><p class="text-gray-400 mb-6">An√°lise da sua pr√°xis hist√≥rica para guiar a luta futura.</p><div class="grid lg:grid-cols-2 gap-8"><div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700"><h3 class="font-semibold text-lg text-purple-300 mb-3">Registro Semanal da Pr√°xis</h3><div id="weekly-log-container"></div><div class="flex justify-around mt-4 text-center"><p class="text-sm">Pontos do Dia: <span id="daily-score" class="font-bold text-green-400">0</span></p><p class="text-sm">Pontos da Semana: <span id="weekly-score" class="font-bold text-purple-300">0</span></p></div></div><div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700"><h3 class="font-semibold text-lg text-purple-300 mb-3">Acumula√ß√£o de Palavras</h3><div class="relative h-48"><canvas id="words-history-chart"></canvas></div></div></div><h3 class="font-semibold text-lg text-purple-300 mt-8 mb-3">Conquistas da Revolu√ß√£o</h3><div id="achievements-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div></div></section>
        </main>
    </div>

    <script>
    //<![CDATA[
    document.addEventListener('DOMContentLoaded', function() {
        let appData;
        let focusInterval;
        let audioCtx, oscillator, gainNode;
        let itemToDelete = null;
        let selectedDuration = 5400;
        let wordsHistoryChart;

        const defaultData = {
            totalWords: 0,
            focusSessionsCompleted: 0,
            wordCountHistory: {},
            weeklyLog: {},
            achievements: {
                firstTask: false, first1000Words: false, allDaily: false, marathon5days: false, focusMaster10: false,
                points50: false, points150: false, points300: false,
                words5k: false, words15k: false,
                completedChapters: [], completedSubchapters: []
            },
            dissertation: [
                { id: 'ch0', title: 'Introdu√ß√£o', subchapters: [], completed: false },
                { id: 'ch1', title: 'Cap√≠tulo 1: Aliena√ß√£o, totalidade e hist√≥ria como categorias centrais do pensamento lukacsiano', completed: false, subchapters: [
                    { id: 'sc1-1', title: '1.1: Hist√≥ria e consci√™ncia de classe como um caminho para Marx...', tasks: [], completed: false },
                    { id: 'sc1-2', title: '1.2: Autocr√≠ticas e inflex√µes: o "tertium datur"...', tasks: [], completed: false },
                    { id: 'sc1-3', title: '1.3: O marxismo como Weltanschauung...', tasks: [], completed: false }
                ]},
                { id: 'ch2', title: 'Cap√≠tulo 2: A forma√ß√£o do pensamento lukacsiano brasileiro', completed: false, subchapters: [
                    { id: 'sc2-1', title: '2.1: A descoberta de Luk√°cs e as contradi√ß√µes...', tasks: [], completed: false },
                    { id: 'sc2-2', title: '2.2: O surgimento do ‚Äúlukacsianismo brasileiro‚Äù', tasks: [], completed: false },
                    { id: 'sc2-3', title: '2.3: O lukacsianismo brasileiro em duas vertentes...', tasks: [], completed: false },
                    { id: 'sc2-4', title: '2.4: A luta te√≥rico-ideol√≥gica por uma nova pol√≠tica...', tasks: [], completed: false }
                ]},
                { id: 'ch3', title: 'Cap√≠tulo 3: O di√°logo com o mestre e a evolu√ß√£o...', completed: false, subchapters: [
                    { id: 'sc3-1', title: '3.1: A correspond√™ncia como meio de forma√ß√£o...', tasks: [], completed: false },
                    { id: 'sc3-2', title: '3.2: Leandro Konder: aliena√ß√£o, realismo...', tasks: [], completed: false },
                    { id: 'sc3-3', title: '3.3: Carlos Nelson Coutinho: entre o ‚Äúhistoricismo‚Äù...', tasks: [], completed: false }
                ]},
                { id: 'ch4', title: 'Considera√ß√µes finais', subchapters: [], completed: false },
                { id: 'ch5', title: 'Refer√™ncias', subchapters: [], completed: false },
                { id: 'ch6', title: 'Anexos', subchapters: [], completed: false }
            ],
            taskTemplates: {
                weekday: [
                    { id: 'dt1', title: 'Bloco 1: Escrita', description: 'O momento de maior energia deve ser dedicado √† tarefa mais dif√≠cil: a produ√ß√£o de texto. O objetivo √© desenvolver um subcap√≠tulo ou atingir uma meta de palavras, usando apenas anota√ß√µes j√° existentes. (10 Pontos)', points: 10 },
                    { id: 'dt2', title: 'Bloco 2: Leitura e Fichamento', description: 'Ap√≥s a escrita, o foco se volta para a leitura e fichamento dos materiais necess√°rios para a pr√≥xima sess√£o de escrita. Este √© o momento de acumular o conhecimento que ser√° transformado em texto. (10 Pontos)', points: 10 },
                    { id: 'dt3', title: 'Bloco 3: Organiza√ß√£o', description: 'Uma sess√£o de baixa intensidade para organizar as notas do dia, planejar em t√≥picos a escrita do dia seguinte e limpar a √°rea de trabalho. Concluir este bloco garante uma vantagem estrat√©gica para o dia seguinte. (5 Pontos B√¥nus)', points: 5 },
                ],
                saturday: [
                    { id: 'sat1', title: 'Bloco 1: Revis√£o Semanal', description: 'Ler e corrigir o que foi escrito durante a semana, identificando pontos fracos e necessidades de revis√£o. (7 Pontos)', points: 7 },
                    { id: 'sat2', title: 'Bloco 2: Planejamento Leve', description: 'Organizar as leituras e metas de escrita para a pr√≥xima semana, sem a press√£o da execu√ß√£o imediata. (5 Pontos)', points: 5 },
                ],
                sunday: [
                    { id: 'sun1', title: 'Bloco Opcional de Fim de Semana', description: 'Uma sess√£o de foco para tirar o atraso de pend√™ncias ou adiantar o trabalho da semana, garantindo uma vantagem estrat√©gica. (15 Pontos B√¥nus)', points: 15 }
                ]
            }
        };
        
        const ALL_ACHIEVEMENTS = {
            general: {
                firstTask: { title: 'Fragmento Superado!', description: 'Concluiu a primeira tarefa. A totalidade est√° um passo mais perto.' },
                first1000Words: { title: 'Cr√≠tica √† Economia Pol√≠tica (das Palavras)!', description: 'Acumulou 1.000 palavras. A base material da sua tese est√° sendo constru√≠da.' },
                words5k: { title: 'For√ßas Produtivas em Expans√£o!', description: 'Alcan√ßou 5.000 palavras. A superestrutura te√≥rica se fortalece.' },
                words15k: { title: 'Materialismo Hist√≥rico!', description: 'Alcan√ßou 15.000 palavras. A hist√≥ria da sua pesquisa est√° sendo escrita.' },
                allDaily: { title: 'Emancipa√ß√£o do Lazer!', description: 'A jornada de trabalho di√°ria terminou. O tempo livre √© seu por direito!' },
                marathon5days: { title: 'Vanguarda Prolet√°ria!', description: 'Escreveu por 5 dias seguidos. A consist√™ncia √© a arma da revolu√ß√£o.' },
                focusMaster10: { title: 'Mestre da Pr√°xis!', description: 'Completou 10 sess√µes de foco. Sua capacidade de concentra√ß√£o foi elevada.' },
                points50: { title: 'Intelectual Org√¢nico!', description: 'Alcan√ßou 50 pontos. Sua pr√°xis est√° se tornando uma for√ßa material.' },
                points150: { title: 'Hegemonia Conquistada!', description: 'Alcan√ßou 150 pontos. Sua disciplina est√° guiando a luta de classes (acad√™mica).' },
                points300: { title: 'Ditadura do Proletariado (sobre a Procrastina√ß√£o)!', description: 'Alcan√ßou 300 pontos. Voc√™ est√° no controle dos meios de produ√ß√£o (intelectual).'}
            },
            chapters: { /* ... */ },
            subchapters: { /* ... */ }
        };

        const DOMElements = {
            nav: document.getElementById('nav-container'),
            sections: document.querySelectorAll('.main-section'),
            chaptersContainer: document.getElementById('chapters-container'),
            totalProgressBar: document.getElementById('total-progress-bar'),
            totalProgressText: document.getElementById('total-progress-text'),
            dailyTaskList: document.getElementById('daily-task-list'),
            currentDay: document.getElementById('current-day'),
            wordInput: document.getElementById('word-count-input'),
            addWordsBtn: document.getElementById('add-progress-button'),
            totalWordsEl: document.getElementById('total-word-count'),
            newChapterInput: document.getElementById('new-chapter-input'),
            modal: document.getElementById('confirm-modal'),
            modalConfirm: document.getElementById('modal-confirm'),
            modalCancel: document.getElementById('modal-cancel'),
            startFocusBtn: document.getElementById('start-focus-btn'),
            focusModal: document.getElementById('focus-modal'),
            focusModalCancel: document.getElementById('focus-modal-cancel'),
            focusModalStart: document.getElementById('focus-modal-start'),
            focusDurationOptions: document.getElementById('focus-duration-options'),
            focusGoalInput: document.getElementById('focus-goal-input'),
            focusFullscreenCheckbox: document.getElementById('focus-fullscreen-checkbox'),
            focusPanel: document.getElementById('focus-panel'),
            focusPanelGoal: document.getElementById('focus-panel-goal'),
            focusPanelTimer: document.getElementById('focus-panel-timer'),
            focusPanelProgress: document.getElementById('focus-panel-progress'),
            focusPanelStop: document.getElementById('focus-panel-stop'),
            fullscreenBtn: document.getElementById('fullscreen-btn'),
            soundPanelToggle: document.getElementById('sound-panel-toggle'),
            soundPanel: document.getElementById('sound-panel'),
            achievementsContainer: document.getElementById('achievements-container'),
            weeklyLogContainer: document.getElementById('weekly-log-container'),
            dailyScoreEl: document.getElementById('daily-score'),
            weeklyScoreEl: document.getElementById('weekly-score'),
            saveDailyBtn: document.getElementById('save-daily-btn'),
            saveManifestoBtn: document.getElementById('save-manifesto-btn'),
            wordsHistoryChartCanvas: document.getElementById('words-history-chart')
        };
        
        function getTodayString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function saveData() { localStorage.setItem('dissertationAppData', JSON.stringify(appData)); }
        function loadData() {
            const savedData = localStorage.getItem('dissertationAppData');
            appData = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(defaultData));
        }

        function showAchievement(title, message) {
            const toast = document.getElementById('achievement-toast');
            toast.querySelector('#achievement-title').textContent = title;
            toast.querySelector('#achievement-message').textContent = message;
            toast.style.top = '20px';
            setTimeout(() => { toast.style.top = '-100px'; }, 5000);
        }

        function checkAchievements(type, data = {}) {
            let achievementData = null;
            switch(type) {
                case 'FIRST_TASK': if (!appData.achievements.firstTask) { appData.achievements.firstTask = true; achievementData = ALL_ACHIEVEMENTS.general.firstTask; } break;
                case 'SUBCHAPTER_COMPLETE': if (!appData.achievements.completedSubchapters.includes(data.subchapterId) && ALL_ACHIEVEMENTS.subchapters[data.subchapterId]) { appData.achievements.completedSubchapters.push(data.subchapterId); achievementData = ALL_ACHIEVEMENTS.subchapters[data.subchapterId]; } break;
                case 'CHAPTER_COMPLETE': if (!appData.achievements.completedChapters.includes(data.chapterId) && ALL_ACHIEVEMENTS.chapters[data.chapterId]) { appData.achievements.completedChapters.push(data.chapterId); achievementData = ALL_ACHIEVEMENTS.chapters[data.chapterId]; } break;
                case 'WORD_COUNT':
                    if (appData.totalWords >= 15000 && !appData.achievements.words15k) { appData.achievements.words15k = true; achievementData = ALL_ACHIEVEMENTS.general.words15k; }
                    else if (appData.totalWords >= 5000 && !appData.achievements.words5k) { appData.achievements.words5k = true; achievementData = ALL_ACHIEVEMENTS.general.words5k; }
                    else if (appData.totalWords >= 1000 && !appData.achievements.first1000Words) { appData.achievements.first1000Words = true; achievementData = ALL_ACHIEVEMENTS.general.first1000Words; }
                    break;
                case 'DAILY_COMPLETE':
                    const today = new Date();
                    const tasksForToday = getTasksForDay(today.getDay());
                    const todayStr = getTodayString();
                    const todayLog = appData.weeklyLog[todayStr] || {};
                    const allDone = tasksForToday.every(task => todayLog[task.id] === true);
                    if (allDone) { achievementData = ALL_ACHIEVEMENTS.general.allDaily; }
                    break;
                case 'FOCUS_SESSION': appData.focusSessionsCompleted = (appData.focusSessionsCompleted || 0) + 1; if (appData.focusSessionsCompleted >= 10 && !appData.achievements.focusMaster10) { appData.achievements.focusMaster10 = true; achievementData = ALL_ACHIEVEMENTS.general.focusMaster10; } break;
                case 'STREAK': if (!appData.achievements.marathon5days) {
                    const history = Object.keys(appData.wordCountHistory).sort();
                    if (history.length >= 5) {
                        let consecutiveDays = 1;
                        for (let i = history.length - 1; i > 0; i--) {
                            const today = new Date(history[i]);
                            const yesterday = new Date(history[i-1]);
                            const diffTime = Math.abs(today - yesterday);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            if (diffDays === 1) { consecutiveDays++; } else { break; }
                        }
                        if (consecutiveDays >= 5) { appData.achievements.marathon5days = true; achievementData = ALL_ACHIEVEMENTS.general.marathon5days; }
                    }
                } break;
                case 'POINTS':
                    if(appData.weeklyScore >= 300 && !appData.achievements.points300) { appData.achievements.points300 = true; achievementData = ALL_ACHIEVEMENTS.general.points300; }
                    else if(appData.weeklyScore >= 150 && !appData.achievements.points150) { appData.achievements.points150 = true; achievementData = ALL_ACHIEVEMENTS.general.points150; }
                    else if(appData.weeklyScore >= 50 && !appData.achievements.points50) { appData.achievements.points50 = true; achievementData = ALL_ACHIEVEMENTS.general.points50; }
                    break;
            }
            if (achievementData) {
                showAchievement(achievementData.title, achievementData.description || achievementData.msg);
                renderAchievements();
                saveData();
            }
        }

        function renderAchievements() {
            const container = DOMElements.achievementsContainer;
            if (!container) return;
            const allAch = {...ALL_ACHIEVEMENTS.general, ...ALL_ACHIEVEMENTS.chapters};
            container.innerHTML = Object.entries(allAch).map(([key, value]) => {
                let isUnlocked = appData.achievements[key];
                if (key.startsWith('ch')) isUnlocked = appData.achievements.completedChapters.includes(key);
                
                return `<div class="achievement-card ${isUnlocked ? '' : 'locked'} bg-gray-900/50 p-4 rounded-lg border border-gray-700 flex items-center space-x-4 transition"><div class="text-3xl">${isUnlocked ? 'üèÜ' : '‚ùì'}</div><div><h4 class="font-bold text-white">${value.title}</h4><p class="text-sm text-gray-400">${value.description}</p></div></div>`;
            }).join('');
        }

        function updatePoints() {
            const today = getTodayString();
            let dailyScore = 0;
            const todayLog = appData.weeklyLog[today] || {};
            const tasksForToday = getTasksForDay(new Date().getDay());
            
            tasksForToday.forEach(task => {
                if(todayLog[task.id]) {
                    dailyScore += task.points;
                }
            });

            const startOfWeek = new Date();
            const day = startOfWeek.getDay();
            const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1); 
            startOfWeek.setDate(diff);
            startOfWeek.setHours(0,0,0,0);

            let weeklyScore = 0;
            for(let i=0; i<7; i++) {
                const d = new Date(startOfWeek);
                d.setDate(startOfWeek.getDate() + i);
                const dateString = d.toISOString().split('T')[0];
                if(appData.weeklyLog[dateString]) {
                    const tasksForDay = getTasksForDay(d.getDay());
                    Object.keys(appData.weeklyLog[dateString]).forEach(taskId => {
                        if(appData.weeklyLog[dateString][taskId]) {
                            const task = tasksForDay.find(t => t.id === taskId);
                            if (task) weeklyScore += task.points;
                        }
                    });
                }
            }
            appData.weeklyScore = weeklyScore;

            DOMElements.dailyScoreEl.textContent = dailyScore;
            DOMElements.weeklyScoreEl.textContent = weeklyScore;
            checkAchievements('POINTS');
        }

        function renderWeeklyLog() {
            const container = DOMElements.weeklyLogContainer;
            if (!container) return;
            container.innerHTML = '';
            const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            const startOfWeek = new Date();
            const day = startOfWeek.getDay();
            const diff = startOfWeek.getDate() - day; 
            startOfWeek.setDate(diff);
            startOfWeek.setHours(0,0,0,0);

            let table = `<table class="w-full text-center text-xs"><thead><tr>`;
            weekDays.forEach(d => table += `<th class="font-normal text-gray-400 pb-2">${d}</th>`);
            table += `</tr></thead><tbody><tr>`;

            for(let i=0; i<7; i++) {
                const d = new Date(startOfWeek);
                d.setDate(startOfWeek.getDate() + i);
                const dateString = d.toISOString().split('T')[0];
                const log = appData.weeklyLog[dateString] || {};
                const tasksForDay = getTasksForDay(d.getDay());
                
                table += `<td class="p-1"><div class="flex justify-center items-center gap-1">`;
                tasksForDay.forEach(task => {
                    let color = 'bg-gray-600';
                    if(log[task.id] === true) color = task.points === 5 || task.points === 15 ? 'bg-purple-500' : 'bg-green-500';
                    table += `<div class="week-log-day-block ${color}" title="${task.title}"></div>`;
                });
                table += `</div></td>`;
            }
            table += `</tr></tbody></table>`;
            container.innerHTML = table;
        }

        function renderWordsHistoryChart() {
            const canvas = DOMElements.wordsHistoryChartCanvas;
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            const history = appData.wordCountHistory;
            const sortedDates = Object.keys(history).sort((a, b) => new Date(a) - new Date(b));
            
            const data = sortedDates.map(date => {
                return { x: date, y: history[date] };
            });

            if (wordsHistoryChart) {
                wordsHistoryChart.destroy();
            }

            wordsHistoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Palavras Escritas por Dia',
                        data: data,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'day' }, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#9ca3af' } },
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#9ca3af' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateProgress() {
            let totalItems = 0, completedItems = 0;
            appData.dissertation.forEach(chapter => {
                let chapterTotal = 0, chapterCompleted = 0;
                if (chapter.subchapters.length > 0) {
                    chapter.subchapters.forEach(sub => {
                        chapterTotal++;
                        if (sub.completed) chapterCompleted++;
                    });
                } else {
                    chapterTotal = 1;
                    if(chapter.completed) chapterCompleted = 1;
                }
                totalItems += chapterTotal;
                completedItems += chapterCompleted;

                const chapterProgress = chapterTotal > 0 ? (chapterCompleted / chapterTotal) * 100 : 0;
                const progressBar = document.querySelector(`#progress-${chapter.id}`);
                const progressText = document.querySelector(`#progress-text-${chapter.id}`);
                if (progressBar) progressBar.style.width = `${chapterProgress}%`;
                if (progressText) progressText.textContent = `${Math.round(chapterProgress)}%`;
                if (chapterProgress === 100 && chapterTotal > 0) {
                    checkAchievements('CHAPTER_COMPLETE', { chapterId: chapter.id, chapterTitle: chapter.title });
                }
            });
            const totalProgress = totalItems > 0 ? (completedItems / totalItems) * 100 : 0;
            DOMElements.totalProgressBar.style.width = `${totalProgress}%`;
            DOMElements.totalProgressText.textContent = `${Math.round(totalProgress)}%`;
        }
        
        function renderDissertationMap() {
            DOMElements.chaptersContainer.innerHTML = appData.dissertation.map(chapter => {
                const hasSubchapters = chapter.subchapters.length > 0;
                const chapterItemClass = chapter.completed ? 'completed' : '';
                return `
                <div class="bg-gray-900/50 border border-gray-700 rounded-lg chapter-item ${chapterItemClass}" data-id="${chapter.id}" data-type="chapter">
                    <div class="accordion-button w-full p-4 text-left flex justify-between items-center cursor-pointer chapter-header">
                        <div class="flex-grow">
                            <h3 class="font-bold text-lg text-white editable">${chapter.title}</h3>
                            ${hasSubchapters ? `<div class="w-full progress-bar-bg rounded-full h-2.5 mt-2"><div id="progress-${chapter.id}" class="chapter-progress-bar-fill h-2.5 rounded-full"></div></div>` : ''}
                        </div>
                        <div class="flex items-center ml-4">
                            ${hasSubchapters ? `<span id="progress-text-${chapter.id}" class="text-sm font-medium text-green-300 mr-4"></span>` : `<button class="complete-btn text-2xl ${chapter.completed ? 'text-green-400' : 'text-gray-600'} hover:text-green-300 mr-4" title="Marcar como Conclu√≠do">${chapter.completed ? '‚úî' : '‚óã'}</button>`}
                            <button class="delete-btn text-red-500 hover:text-red-400 mr-4" title="Excluir Cap√≠tulo">&#10005;</button>
                            ${hasSubchapters ? `<span class="transform transition-transform duration-300 text-gray-400">&#9662;</span>` : ''}
                        </div>
                    </div>
                    ${hasSubchapters ? `<div class="accordion-content px-4 pb-4">
                        <div class="subchapters-list space-y-4 mt-4">
                        ${chapter.subchapters.map(sub => {
                            const subItemClass = sub.completed ? 'completed' : '';
                            return `
                            <div class="pl-4 border-l-2 border-gray-700 subchapter-item ${subItemClass}" data-id="${sub.id}" data-type="subchapter">
                                <div class="flex justify-between items-center subchapter-title"><h4 class="font-semibold text-purple-300 editable flex-grow">${sub.title}</h4><div class="flex items-center"><button class="complete-btn text-2xl ${sub.completed ? 'text-green-400' : 'text-gray-600'} hover:text-green-300 mr-2" title="Marcar como Conclu√≠do">${sub.completed ? '‚úî' : '‚óã'}</button><button class="delete-btn text-red-500 hover:text-red-400 ml-2" title="Excluir Subcap√≠tulo">&#10005;</button></div></div>
                                <div class="tasks-list mt-2 space-y-2">
                                    ${sub.tasks.map(task => `<div class="task-item flex items-center" data-id="${task.id}" data-type="task"><input type="checkbox" id="${task.id}" ${task.completed ? 'checked' : ''} class="h-4 w-4 rounded bg-gray-600 border-gray-500 text-purple-500 focus:ring-purple-600"><label for="${task.id}" class="task-label ml-3 text-sm text-gray-300 editable flex-grow">${task.text}</label><button class="delete-btn text-red-500 hover:text-red-400 ml-2" title="Excluir Tarefa">&#10005;</button></div>`).join('')}
                                </div>
                                <div class="mt-2"><input type="text" class="new-item-input bg-gray-700 border border-gray-600 text-sm rounded-md w-full p-1" placeholder="+ Adicionar nova tarefa..." data-type="task"/></div>
                            </div>`}).join('')}
                        </div>
                         <div class="mt-4 pt-4 border-t border-gray-700"><input type="text" class="new-item-input bg-gray-700 border border-gray-600 text-sm rounded-md w-full p-1" placeholder="+ Adicionar novo subcap√≠tulo..." data-type="subchapter"/></div>
                    </div>` : ''}
                </div>`}).join('');
            updateProgress();
        }

        function getTasksForDay(dayIndex) {
            if (dayIndex === 6) return appData.taskTemplates.saturday;
            if (dayIndex === 0) return appData.taskTemplates.sunday;
            return appData.taskTemplates.weekday;
        }

        function renderDailyPanel() {
            const today = new Date();
            const dayIndex = today.getDay();
            const dayNames = ["Domingo", "Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado"];
            DOMElements.currentDay.textContent = dayNames[dayIndex];
            
            const taskListContainer = DOMElements.dailyTaskList;
            taskListContainer.innerHTML = '';

            if (dayIndex === 0) { // Domingo
                taskListContainer.innerHTML = `
                    <div class="text-center p-8">
                        <p class="text-gray-400">Domingo √© dia de recarregar as energias para a luta da pr√≥xima semana. O descanso tamb√©m √© revolucion√°rio.</p>
                        <button id="sunday-optional-btn" class="mt-4 bg-purple-800 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">Preciso Avan√ßar (Bloco Opcional)</button>
                    </div>
                `;
                document.getElementById('sunday-optional-btn').addEventListener('click', () => {
                    renderTasks(appData.taskTemplates.sunday);
                });
            } else {
                const tasksForToday = getTasksForDay(dayIndex);
                renderTasks(tasksForToday);
            }
        }

        function renderTasks(tasks) {
            const todayLog = appData.weeklyLog[getTodayString()] || {};
            DOMElements.dailyTaskList.innerHTML = tasks.map(task => {
                const isChecked = todayLog[task.id] || false;
                return `<div class="task-item flex items-start p-4 border border-gray-700 rounded-lg bg-gray-900/50"><div class="flex items-center h-6"><input id="${task.id}" type="checkbox" ${isChecked ? 'checked' : ''} class="h-5 w-5 rounded bg-gray-600 border-gray-500 text-purple-500 focus:ring-purple-600"></div><div class="ml-4 text-sm"><label for="${task.id}" class="font-bold text-white">${task.title}</label><p class="text-gray-400">${task.description}</p></div></div>`
            }).join('');
        }
        
        function makeEditable(e) {
            if (!e.target.classList.contains('editable')) return;
            // ... (restante da fun√ß√£o)
        }
        
        function handleItemCreation(e) {
            // ... (restante da fun√ß√£o)
        }

        function handleDelete(e) {
            // ... (restante da fun√ß√£o)
        }

        DOMElements.modalConfirm.addEventListener('click', () => {
            // ... (restante da fun√ß√£o)
        });
        
        DOMElements.modalCancel.addEventListener('click', () => {
            // ... (restante da fun√ß√£o)
        });

        DOMElements.nav.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const targetId = e.target.dataset.target;
                DOMElements.sections.forEach(section => section.classList.add('hidden'));
                document.getElementById(targetId).classList.remove('hidden');
                DOMElements.nav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
            }
        });

        DOMElements.chaptersContainer.addEventListener('click', (e) => {
            // ... (restante da fun√ß√£o)
        });
        DOMElements.chaptersContainer.addEventListener('dblclick', makeEditable);
        DOMElements.chaptersContainer.addEventListener('keypress', handleItemCreation);
        DOMElements.newChapterInput.addEventListener('keypress', handleItemCreation);
        
        DOMElements.saveManifestoBtn.addEventListener('click', () => {
            // ... (restante da fun√ß√£o)
        });

        DOMElements.saveDailyBtn.addEventListener('click', () => {
            const today = getTodayString();
            if (!appData.weeklyLog[today]) appData.weeklyLog[today] = {};

            DOMElements.dailyTaskList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                appData.weeklyLog[today][checkbox.id] = checkbox.checked;
            });
            
            updatePoints();
            renderWeeklyLog();
            checkAchievements('DAILY_COMPLETE');
            saveData();
            showAchievement("Pr√°xis Registrada!", "O balan√ßo do dia foi salvo. A luta continua amanh√£.");
        });

        DOMElements.addWordsBtn.addEventListener('click', () => {
            // ... (restante da fun√ß√£o)
        });

        function startFocusTimer(duration, goal) {
            // ... (restante da fun√ß√£o)
        }

        function stopFocusTimer(completed = false) {
            // ... (restante da fun√ß√£o)
        }

        DOMElements.startFocusBtn.addEventListener('click', () => DOMElements.focusModal.classList.remove('hidden'));
        DOMElements.focusModalCancel.addEventListener('click', () => DOMElements.focusModal.classList.add('hidden'));
        DOMElements.focusDurationOptions.addEventListener('click', (e) => {
            // ... (restante da fun√ß√£o)
        });
        DOMElements.focusModalStart.addEventListener('click', () => {
            // ... (restante da fun√ß√£o)
        });
        DOMElements.focusPanelStop.addEventListener('click', () => stopFocusTimer(false));

        DOMElements.fullscreenBtn.addEventListener('click', () => {
            // ... (restante da fun√ß√£o)
        });
        
        function stopSound() {
            // ... (restante da fun√ß√£o)
        }

        function playSound(soundType) {
            // ... (restante da fun√ß√£o)
        }

        DOMElements.soundPanelToggle.addEventListener('click', () => {
             if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
             DOMElements.soundPanel.classList.toggle('hidden');
        });
        DOMElements.soundPanel.addEventListener('click', (e) => {
            // ... (restante da fun√ß√£o)
        });
        
        function init() {
            loadData();
            renderDailyPanel();
            renderDissertationMap();
            renderAchievements();
            renderWeeklyLog();
            renderWordsHistoryChart();
            updatePoints();
            DOMElements.totalWordsEl.textContent = appData.totalWords || 0;
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + (startOfWeek.getDay() === 0 ? -6 : 1));
            startOfWeek.setHours(0,0,0,0);
            
            const lastLogDateStr = Object.keys(appData.weeklyLog).pop();
            if(lastLogDateStr) {
                const lastLogWeekStart = new Date(lastLogDateStr);
                lastLogWeekStart.setDate(lastLogWeekStart.getDate() - lastLogWeekStart.getDay() + (lastLogWeekStart.getDay() === 0 ? -6 : 1));
                lastLogWeekStart.setHours(0,0,0,0);
                if(startOfWeek > lastLogWeekStart) {
                    appData.weeklyLog = {};
                    appData.weeklyScore = 0;
                    saveData();
                }
            }
        }
        
        init();
    });
    //]]>
    </script>
</body>
</html>
