<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel da Pr√°xis</title>
    <style>
        /* Estilos Gerais e Tem√°tica */
        :root {
            --cor-fundo: #1e1e1e;
            --cor-texto: #e0e0e0;
            --cor-primaria: #b71c1c; /* Vermelho Revolucion√°rio */
            --cor-secundaria: #424242;
            --cor-terciaria: #616161;
            --cor-sucesso: #4caf50; /* Verde */
            --cor-bonus: #9c27b0; /* Roxo */
            --cor-conquista: #ffc107; /* Dourado */
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            margin: 0;
            padding: 0;
            overscroll-behavior-y: contain;
        }
        .container {
            padding: 15px;
            padding-bottom: 80px; /* Espa√ßo para a navega√ß√£o fixa */
        }
        h1, h2, h3 {
            color: var(--cor-primaria);
            border-bottom: 1px solid var(--cor-secundaria);
            padding-bottom: 5px;
            font-weight: 500;
        }

        /* Navega√ß√£o */
        .nav-bar {
            display: flex;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--cor-secundaria);
            border-top: 2px solid var(--cor-primaria);
        }
        .nav-button {
            flex: 1;
            padding: 15px 5px;
            text-align: center;
            background: none;
            border: none;
            color: var(--cor-texto);
            font-size: 14px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .nav-button.active {
            background-color: var(--cor-terciaria);
            border-bottom: 3px solid var(--cor-primaria);
        }

        /* Conte√∫do das Abas */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Estilos Comuns */
        .card {
            background-color: var(--cor-secundaria);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .card-title {
            margin-top: 0;
            font-size: 1.2em;
        }
        .btn-salvar {
            display: block;
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            color: white;
            background-color: var(--cor-primaria);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        input[type="number"], input[type="text"] {
            width: calc(100% - 20px);
            padding: 10px;
            background-color: var(--cor-terciaria);
            border: 1px solid #757575;
            color: var(--cor-texto);
            border-radius: 4px;
            font-size: 1em;
        }
        
        /* Aba 1: Pr√°xis Di√°ria */
        .task-block {
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid var(--cor-primaria);
        }
        .task-block.bonus {
            border-left: 4px solid var(--cor-bonus);
        }
        .task-block label {
            display: flex;
            align-items: center;
            font-size: 1.1em;
        }
        .task-block input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        .task-desc {
            font-size: 0.8em;
            color: #bdbdbd;
            margin-left: 30px;
        }
        .btn-opcional {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: var(--cor-bonus);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Aba 2: A Busca pela Totalidade */
        .dissertacao-item {
            background-color: var(--cor-terciaria);
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .dissertacao-item.subcapitulo {
            margin-left: 20px;
        }
        .item-titulo { flex-grow: 1; }
        .item-actions { display: flex; align-items: center; gap: 10px; }
        .btn-concluir {
            padding: 5px 10px;
            font-size: 0.8em;
            background-color: var(--cor-sucesso);
            color: white; border: none; border-radius: 4px; cursor: pointer;
        }
        .btn-concluir.concluido { background-color: #616161; text-decoration: line-through; }
        .btn-delete { color: #ef5350; cursor: pointer; font-size: 1.2em; }
        .btn-add {
            padding: 8px 12px;
            background-color: var(--cor-primaria);
            color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #424242;
            border-radius: 5px;
            margin: 5px 0 15px 0;
        }
        .progress-bar {
            width: 0%;
            height: 12px;
            background-color: var(--cor-sucesso);
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
            text-align: center;
            color: white;
            font-size: 0.7em;
            line-height: 12px;
        }

        /* Aba 3: Balan√ßo Hist√≥rico */
        .semana-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px; text-align: center;
        }
        .dia-header { font-size: 0.8em; margin-bottom: 5px; }
        .dia-status {
            width: 100%;
            padding-top: 100%; /* Aspect ratio 1:1 */
            position: relative;
            background-color: var(--cor-terciaria);
            border-radius: 4px;
        }
        .dia-status-inner {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            padding: 3px;
        }
        .bloco-status {
            height: 25%;
            width: 100%;
            border-radius: 2px;
            background-color: #616161;
        }
        .bloco-status.concluido-main { background-color: var(--cor-sucesso); }
        .bloco-status.concluido-bonus { background-color: var(--cor-bonus); }
        #chart-container { margin-top: 20px; }

        /* Conquistas */
        .conquistas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px;
            text-align: center;
        }
        .conquista {
            cursor: pointer;
        }
        .conquista-icone {
            font-size: 3em;
            filter: grayscale(1);
            opacity: 0.5;
            transition: all 0.3s;
        }
        .conquista.desbloqueada .conquista-icone {
            filter: grayscale(0);
            opacity: 1;
            color: var(--cor-conquista);
        }
        .conquista-nome {
            font-size: 0.8em;
            margin-top: 5px;
        }

        /* Notifica√ß√µes */
        #notification-container {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--cor-conquista);
            color: #1e1e1e;
            padding: 15px 25px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: top 0.5s ease-in-out;
            text-align: center;
            font-weight: bold;
        }
        #notification-container.show {
            top: 0;
        }
    </style>
</head>
<body>

    <div id="app">
        <div id="tab-praxis" class="tab-content active">
            <div class="container">
                <h1>Pr√°xis Di√°ria</h1>
                <div id="praxis-conteudo"></div>
                <div class="card">
                    <h3 class="card-title">Produ√ß√£o Material</h3>
                    <input type="number" id="palavras-dia" placeholder="Palavras escritas hoje">
                    <p>Total Acumulado: <strong id="total-palavras">0</strong> palavras</p>
                </div>
                <button id="salvar-praxis" class="btn-salvar">Salvar Pr√°xis do Dia</button>
            </div>
        </div>

        <div id="tab-totalidade" class="tab-content">
            <div class="container">
                <h1>A Busca pela Totalidade</h1>
                <h3>Progresso Total da Disserta√ß√£o</h3>
                <div class="progress-bar-container">
                    <div id="progresso-total-barra" class="progress-bar"></div>
                </div>
                <div id="dissertacao-estrutura"></div>
                 <div style="text-align: center; margin-top: 20px;">
                    <button id="add-capitulo" class="btn-add">Adicionar Cap√≠tulo</button>
                </div>
                <button id="salvar-totalidade" class="btn-salvar">Salvar Progresso Estrutural</button>
            </div>
        </div>

        <div id="tab-balanco" class="tab-content">
            <div class="container">
                <h1>Balan√ßo Hist√≥rico</h1>
                <div class="card">
                    <h3 class="card-title">Registro Semanal da Luta</h3>
                    <div class="semana-grid">
                        <span>Seg</span><span>Ter</span><span>Qua</span><span>Qui</span><span>Sex</span><span>S√°b</span><span>Dom</span>
                        <div id="dia-1" class="dia-status"><div class="dia-status-inner"></div></div>
                        <div id="dia-2" class="dia-status"><div class="dia-status-inner"></div></div>
                        <div id="dia-3" class="dia-status"><div class="dia-status-inner"></div></div>
                        <div id="dia-4" class="dia-status"><div class="dia-status-inner"></div></div>
                        <div id="dia-5" class="dia-status"><div class="dia-status-inner"></div></div>
                        <div id="dia-6" class="dia-status"><div class="dia-status-inner"></div></div>
                        <div id="dia-0" class="dia-status"><div class="dia-status-inner"></div></div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Sistema de Pontua√ß√£o</h3>
                    <p>Pontos do Dia: <strong id="pontos-dia">0</strong></p>
                    <p>Total Semanal: <strong id="pontos-semana">0</strong></p>
                </div>
                <div class="card">
                    <h3 class="card-title">Gr√°fico de Acumula√ß√£o de Palavras</h3>
                    <div id="chart-container">
                        <canvas id="palavras-chart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Painel de Conquistas</h3>
                    <div id="conquistas-painel" class="conquistas-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <nav class="nav-bar">
        <button class="nav-button active" data-tab="tab-praxis">Pr√°xis Di√°ria</button>
        <button class="nav-button" data-tab="tab-totalidade">A Totalidade</button>
        <button class="nav-button" data-tab="tab-balanco">Balan√ßo Hist√≥rico</button>
    </nav>
    
    <div id="notification-container">
        <p id="notification-text"></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Objeto principal de dados do App
        let appData = {};

        // Configura√ß√µes e Estruturas Padr√£o
        const defaultDissertacao = {
            titulo: "ALIENA√á√ÉO, TOTALIDADE E HIST√ìRIA: A RECEP√á√ÉO DE GY√ñRGY LUK√ÅCS NO BRASIL A PARTIR DE LEANDRO KONDER E CARLOS NELSON COUTINHO (1961-1972)",
            capitulos: [
                { id: 1, titulo: "Introdu√ß√£o", concluido: false, subcapitulos: [] },
                { id: 2, titulo: "Cap√≠tulo 1: Aliena√ß√£o, totalidade e hist√≥ria como categorias centrais do pensamento lukacsiano", concluido: false, subcapitulos: [
                    { id: 21, titulo: "Subcap√≠tulo 1.1: Hist√≥ria e consci√™ncia de classe como um caminho para Marx: a concep√ß√£o da totalidade no ‚Äúmarxismo ortodoxo‚Äù e a reifica√ß√£o", concluido: false },
                    { id: 22, titulo: "Subcap√≠tulo 1.2: Autocr√≠ticas e inflex√µes: o \"tertium datur\" entre o irracionalismo e o dogmatismo", concluido: false },
                    { id: 23, titulo: "Subcap√≠tulo 1.3: O marxismo como Weltanschauung: est√©tica, √©tica e ontologia", concluido: false }
                ]},
                { id: 3, titulo: "Cap√≠tulo 2: A forma√ß√£o do pensamento lukacsiano brasileiro", concluido: false, subcapitulos: [
                    { id: 31, titulo: "Subcap√≠tulo 2.1: A descoberta de Luk√°cs e as contradi√ß√µes da pol√≠tica cultural comunista", concluido: false },
                    { id: 32, titulo: "Subcap√≠tulo 2.2: O surgimento do ‚Äúlukacsianismo brasileiro‚Äù", concluido: false },
                    { id: 33, titulo: "Subcap√≠tulo 2.3: O lukacsianismo brasileiro em duas vertentes: os comunistas no Rio e o grupo ‚ÄúPr√°xis‚Äù de S√£o Paulo", concluido: false },
                    { id: 34, titulo: "Subcap√≠tulo 2.4: A luta te√≥rico-ideol√≥gica por uma nova pol√≠tica cultural comunista", concluido: false }
                ]},
                { id: 4, titulo: "Cap√≠tulo 3: O di√°logo com o mestre e a evolu√ß√£o do lukacsianismo de Konder e Coutinho (1960-1974)", concluido: false, subcapitulos: [
                    { id: 41, titulo: "Subcap√≠tulo 3.1: A correspond√™ncia como meio de forma√ß√£o do lukacsianismo brasileiro", concluido: false },
                    { id: 42, titulo: "Subcap√≠tulo 3.2: Leandro Konder: aliena√ß√£o, realismo e a busca pelo marxismo aut√™ntico", concluido: false },
                    { id: 43, titulo: "Subcap√≠tulo 3.3: Carlos Nelson Coutinho: entre o ‚Äúhistoricismo‚Äù e a dial√©tica objetiva", concluido: false }
                ]},
                { id: 5, titulo: "Considera√ß√µes finais", concluido: false, subcapitulos: [] },
                { id: 6, titulo: "Refer√™ncias", concluido: false, subcapitulos: [] },
                { id: 7, titulo: "Anexos", concluido: false, subcapitulos: [] }
            ]
        };

        const conquistasDef = [
            { id: 'c01', nome: 'In√≠cio da Pr√°xis', desc: 'Concluir a primeira tarefa di√°ria.', desbloqueada: false, check: () => countCompletedTasksToday() > 0 },
            { id: 'c02', nome: 'Consci√™ncia em Si', desc: 'Escrever as primeiras 1000 palavras.', desbloqueada: false, check: () => appData.progresso.totalPalavras >= 1000 },
            { id: 'c03', nome: 'Semana Produtiva', desc: 'Completar tarefas em 5 dias da semana.', desbloqueada: false, check: () => Object.values(appData.progresso.semana).filter(d => d.tarefas.length > 0).length >= 5 },
            { id: 'c04', nome: 'Pontua√ß√£o de Luta', desc: 'Alcan√ßar 50 pontos em uma semana.', desbloqueada: false, check: () => calculatePontosSemana() >= 50 },
            { id: 'c05', nome: 'Totalidade Conquistada', desc: 'Concluir o primeiro cap√≠tulo.', desbloqueada: false, check: () => appData.dissertacao.capitulos.some(c => c.concluido) },
            { id: 'c06', nome: 'O Alicerce', desc: 'Concluir a Introdu√ß√£o.', desbloqueada: false, check: () => appData.dissertacao.capitulos[0].concluido },
            { id: 'c07', nome: 'Consci√™ncia para Si', desc: 'Escrever 10.000 palavras.', desbloqueada: false, check: () => appData.progresso.totalPalavras >= 10000 },
            { id: 'c08', nome: 'Militante Disciplinado', desc: 'Alcan√ßar 100 pontos em uma semana.', desbloqueada: false, check: () => calculatePontosSemana() >= 100 },
            { id: 'c09', nome: 'O Fim da Jornada', desc: 'Concluir todos os cap√≠tulos da disserta√ß√£o.', desbloqueada: false, check: () => isDissertacaoCompleta() },
        ];

        // Fila de Notifica√ß√µes
        let notificationQueue = [];
        let isNotifying = false;

        // Elementos da DOM
        const navButtons = document.querySelectorAll('.nav-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const praxisConteudo = document.getElementById('praxis-conteudo');
        const salvarPraxisBtn = document.getElementById('salvar-praxis');
        const palavrasDiaInput = document.getElementById('palavras-dia');
        
        const dissertacaoEstrutura = document.getElementById('dissertacao-estrutura');
        const salvarTotalidadeBtn = document.getElementById('salvar-totalidade');

        // Inicializa√ß√£o
        function init() {
            loadData();
            setupEventListeners();
            renderAll();
        }

        function loadData() {
            const savedData = localStorage.getItem('painelPraxisData');
            if (savedData) {
                appData = JSON.parse(savedData);
                // Garantir que as defini√ß√µes de conquista estejam atualizadas
                appData.conquistas = mergeConquistas(appData.conquistas, conquistasDef);
            } else {
                appData = {
                    dissertacao: JSON.parse(JSON.stringify(defaultDissertacao)),
                    progresso: {
                        totalPalavras: 0,
                        historicoPalavras: [], // { data: 'YYYY-MM-DD', palavras: X }
                        semana: { 1:{}, 2:{}, 3:{}, 4:{}, 5:{}, 6:{}, 0:{} } // dia da semana: { tarefas: [], pontos: 0 }
                    },
                    conquistas: JSON.parse(JSON.stringify(conquistasDef)),
                    lastWeekReset: getWeekNumber(new Date())
                };
            }
            checkWeekReset();
        }
        
        function mergeConquistas(saved, defaults) {
            return defaults.map(def => {
                const savedConquista = saved.find(s => s.id === def.id);
                return savedConquista ? { ...def, desbloqueada: savedConquista.desbloqueada } : def;
            });
        }
        
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return d.getUTCFullYear() + '-' + weekNo;
        }

        function checkWeekReset() {
            const currentWeek = getWeekNumber(new Date());
            if (appData.lastWeekReset !== currentWeek) {
                appData.progresso.semana = { 1:{}, 2:{}, 3:{}, 4:{}, 5:{}, 6:{}, 0:{} };
                appData.lastWeekReset = currentWeek;
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('painelPraxisData', JSON.stringify(appData));
        }
        
        function setupEventListeners() {
            // Navega√ß√£o
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    button.classList.add('active');
                    document.getElementById(button.dataset.tab).classList.add('active');
                    if (button.dataset.tab === 'tab-balanco') {
                       renderPalavrasChart();
                    }
                });
            });

            // Aba Pr√°xis
            salvarPraxisBtn.addEventListener('click', handlePraxisSave);

            // Aba Totalidade
            salvarTotalidadeBtn.addEventListener('click', handleTotalidadeSave);
            document.getElementById('add-capitulo').addEventListener('click', () => addDissertacaoItem(null));
        }

        // --- L√ìGICA DE RENDERIZA√á√ÉO ---
        function renderAll() {
            renderPraxisDiaria();
            renderTotalidade();
            renderBalanco();
        }

        // Renderiza√ß√£o da Aba 1: Pr√°xis Di√°ria
        function renderPraxisDiaria() {
            const hoje = new Date();
            const diaSemana = hoje.getDay(); // 0-Dom, 1-Seg, ...
            let html = '';

            const tarefasSalvas = appData.progresso.semana[diaSemana]?.tarefas || [];

            if (diaSemana >= 1 && diaSemana <= 5) { // Seg a Sex
                html += createTaskBlock('escrita', 'Escrita', 'Foco total na produ√ß√£o de texto.', 10, tarefasSalvas.includes('escrita'));
                html += createTaskBlock('leitura', 'Leitura', 'Leitura e fichamento de bibliografia.', 5, tarefasSalvas.includes('leitura'));
                html += createTaskBlock('organizacao', 'Organiza√ß√£o', 'Revisar notas, organizar arquivos, etc.', 3, tarefasSalvas.includes('organizacao'));
            } else if (diaSemana === 6) { // S√°bado
                html += createTaskBlock('revisao', 'Revis√£o Semanal', 'Revisar o que foi produzido na semana.', 8, tarefasSalvas.includes('revisao'));
                html += createTaskBlock('planejamento', 'Planejamento Leve', 'Planejar as metas da pr√≥xima semana.', 4, tarefasSalvas.includes('planejamento'));
            } else { // Domingo
                html = '<div class="card"><p>Domingo √© dia de descanso. A pr√°xis tamb√©m envolve a recupera√ß√£o das for√ßas para a luta!</p><button id="btn-avancar" class="btn-opcional">Preciso Avan√ßar</button></div>';
            }
            
            praxisConteudo.innerHTML = html;

            if (document.getElementById('btn-avancar')) {
                document.getElementById('btn-avancar').addEventListener('click', () => {
                    let bonusHtml = createTaskBlock('bonus-domingo', 'Arrancada Final', 'Bloco de alta intensidade para avan√ßar.', 15, tarefasSalvas.includes('bonus-domingo'), true);
                    praxisConteudo.innerHTML = bonusHtml;
                });
            }

            document.getElementById('total-palavras').textContent = appData.progresso.totalPalavras;
            palavrasDiaInput.value = '';
        }

        function createTaskBlock(id, titulo, desc, pontos, checked, isBonus = false) {
            return `
                <div class="card task-block ${isBonus ? 'bonus' : ''}">
                    <label>
                        <input type="checkbox" data-task-id="${id}" data-pontos="${pontos}" ${checked ? 'checked' : ''}>
                        <span>${titulo} (${pontos} pts)</span>
                    </label>
                    <p class="task-desc">${desc}</p>
                </div>
            `;
        }

        // Renderiza√ß√£o da Aba 2: A Busca pela Totalidade
        function renderTotalidade() {
            let html = '';
            appData.dissertacao.capitulos.forEach((cap, capIndex) => {
                html += renderDissertacaoItem(cap, capIndex, null);
                if (cap.subcapitulos.length > 0) {
                    const progressoCap = calculateProgressoCapitulo(cap);
                     html += `
                        <div class="progress-bar-container" style="margin-left: 20px;">
                            <div class="progress-bar" style="width: ${progressoCap}%;">${Math.round(progressoCap)}%</div>
                        </div>
                    `;
                    cap.subcapitulos.forEach((sub, subIndex) => {
                        html += renderDissertacaoItem(sub, capIndex, subIndex);
                    });
                }
            });
            dissertacaoEstrutura.innerHTML = html;
            addTotalidadeEventListeners();
            updateProgressoTotal();
        }

        function renderDissertacaoItem(item, capIndex, subIndex) {
            const isSub = subIndex !== null;
            return `
                <div class="dissertacao-item ${isSub ? 'subcapitulo' : ''}" data-cap-index="${capIndex}" data-sub-index="${subIndex !== null ? subIndex : ''}">
                    <span class="item-titulo" ondblclick="editItemTitle(this, ${capIndex}, ${subIndex})">${item.titulo}</span>
                    <div class="item-actions">
                        ${(item.subcapitulos && item.subcapitulos.length === 0) || isSub ? 
                            `<button class="btn-concluir ${item.concluido ? 'concluido' : ''}" onclick="toggleItemConcluido(${capIndex}, ${subIndex})">${item.concluido ? 'Conclu√≠do' : 'Concluir'}</button>` : 
                            `<button class="btn-add" onclick="addDissertacaoItem(${capIndex})">+</button>`
                        }
                        <span class="btn-delete" onclick="deleteDissertacaoItem(${capIndex}, ${subIndex})">üóëÔ∏è</span>
                    </div>
                </div>
            `;
        }
        
        function updateProgressoTotal() {
            let totalItens = 0;
            let concluidosItens = 0;
            appData.dissertacao.capitulos.forEach(cap => {
                if (cap.subcapitulos.length > 0) {
                     cap.subcapitulos.forEach(sub => {
                        totalItens++;
                        if (sub.concluido) concluidosItens++;
                    });
                } else {
                    totalItens++;
                    if (cap.concluido) concluidosItens++;
                }
            });
            const progressoGeral = totalItens > 0 ? (concluidosItens / totalItens) * 100 : 0;
            const barra = document.getElementById('progresso-total-barra');
            barra.style.width = progressoGeral + '%';
            barra.textContent = Math.round(progressoGeral) + '%';
        }
        
        function calculateProgressoCapitulo(cap) {
            if (!cap.subcapitulos || cap.subcapitulos.length === 0) return cap.concluido ? 100 : 0;
            const concluidos = cap.subcapitulos.filter(s => s.concluido).length;
            return (concluidos / cap.subcapitulos.length) * 100;
        }

        function addTotalidadeEventListeners() {
            // Event listeners for inline functions are already set. This is for more complex setups if needed.
        }

        // Renderiza√ß√£o da Aba 3: Balan√ßo Hist√≥rico
        function renderBalanco() {
            renderRegistroSemanal();
            renderPontuacao();
            renderConquistas();
            renderPalavrasChart(); // Renderiza o gr√°fico se a aba estiver vis√≠vel
        }
        
        function renderRegistroSemanal() {
            for (let i = 0; i <= 6; i++) {
                const diaEl = document.getElementById(`dia-${i}`);
                const diaData = appData.progresso.semana[i];
                let innerHTML = '';
                if (diaData && diaData.tarefas) {
                    const blocos = diaData.tarefas.length > 3 ? 3 : diaData.tarefas.length;
                    for(let j = 0; j < blocos; j++) {
                        const isBonus = diaData.tarefas[j].includes('bonus') || diaData.tarefas[j].includes('revisao');
                        innerHTML += `<div class="bloco-status ${isBonus ? 'concluido-bonus' : 'concluido-main'}"></div>`;
                    }
                }
                diaEl.querySelector('.dia-status-inner').innerHTML = innerHTML;
            }
        }
        
        function renderPontuacao() {
            const hoje = new Date().getDay();
            const pontosHoje = appData.progresso.semana[hoje]?.pontos || 0;
            const pontosSemana = calculatePontosSemana();
            document.getElementById('pontos-dia').textContent = pontosHoje;
            document.getElementById('pontos-semana').textContent = pontosSemana;
        }
        
        function calculatePontosSemana() {
            return Object.values(appData.progresso.semana).reduce((total, dia) => total + (dia.pontos || 0), 0);
        }

        function renderConquistas() {
            const painel = document.getElementById('conquistas-painel');
            let html = '';
            appData.conquistas.forEach(c => {
                html += `
                    <div class="conquista ${c.desbloqueada ? 'desbloqueada' : ''}" onclick="alert('${c.desbloqueada ? 'Conquistado: ' : ''}${c.desc}')">
                        <span class="conquista-icone">${c.desbloqueada ? 'üèÜ' : '‚ùì'}</span>
                        <span class="conquista-nome">${c.nome}</span>
                    </div>
                `;
            });
            painel.innerHTML = html;
        }
        
        let palavrasChartInstance = null;
        function renderPalavrasChart() {
            if (!document.getElementById('tab-balanco').classList.contains('active')) return;
            
            const ctx = document.getElementById('palavras-chart').getContext('2d');
            const historico = appData.progresso.historicoPalavras;
            
            // Acumular os totais
            let cumulativeTotal = 0;
            const cumulativeData = historico.map(entry => {
                cumulativeTotal += entry.palavras;
                return { data: entry.data, total: cumulativeTotal };
            });

            const labels = cumulativeData.map(h => new Date(h.data).toLocaleDateString('pt-BR'));
            const data = cumulativeData.map(h => h.total);

            if (palavrasChartInstance) {
                palavrasChartInstance.destroy();
            }

            palavrasChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total de Palavras Acumuladas',
                        data: data,
                        borderColor: 'rgba(183, 28, 28, 1)',
                        backgroundColor: 'rgba(183, 28, 28, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }


        // --- L√ìGICA DE MANIPULA√á√ÉO DE DADOS E EVENTOS ---

        function handlePraxisSave() {
            const hoje = new Date();
            const diaSemana = hoje.getDay();
            const hojeStr = hoje.toISOString().split('T')[0];

            // Salvar tarefas e pontos
            const checkboxes = document.querySelectorAll('#praxis-conteudo input[type="checkbox"]');
            let tarefasConcluidas = [];
            let pontosDia = 0;
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    tarefasConcluidas.push(cb.dataset.taskId);
                    pontosDia += parseInt(cb.dataset.pontos, 10);
                }
            });
            appData.progresso.semana[diaSemana] = { tarefas: tarefasConcluidas, pontos: pontosDia };
            
            // Salvar palavras
            const palavrasHoje = parseInt(palavrasDiaInput.value, 10) || 0;
            if (palavrasHoje > 0) {
                appData.progresso.totalPalavras += palavrasHoje;
                const historicoEntry = appData.progresso.historicoPalavras.find(h => h.data === hojeStr);
                if (historicoEntry) {
                    historicoEntry.palavras += palavrasHoje;
                } else {
                    appData.progresso.historicoPalavras.push({ data: hojeStr, palavras: palavrasHoje });
                }
            }

            checkAndUnlockConquistas();
            saveData();
            renderAll();
            alert('Pr√°xis di√°ria registrada com sucesso!');
        }
        
        function handleTotalidadeSave() {
            // A estrutura j√° √© atualizada em tempo real no objeto appData pelas fun√ß√µes `onclick`
            checkAndUnlockConquistas();
            saveData();
            renderTotalidade(); // Re-renderizar para atualizar visualmente
            alert('Estrutura e progresso da Totalidade salvos!');
        }

        // Fun√ß√µes globais para serem chamadas pelo HTML inline
        window.toggleItemConcluido = function(capIndex, subIndex) {
            let item;
            if (subIndex !== null) {
                item = appData.dissertacao.capitulos[capIndex].subcapitulos[subIndex];
            } else {
                item = appData.dissertacao.capitulos[capIndex];
            }
            item.concluido = !item.concluido;
            
            // Se um capitulo com subcap√≠tulos tem todos eles conclu√≠dos, o cap√≠tulo √© conclu√≠do
            const cap = appData.dissertacao.capitulos[capIndex];
            if (cap.subcapitulos.length > 0) {
                cap.concluido = cap.subcapitulos.every(s => s.concluido);
            }

            renderTotalidade();
        }

        window.deleteDissertacaoItem = function(capIndex, subIndex) {
            const confirmacao = confirm('Tem certeza que deseja apagar este item? Esta a√ß√£o n√£o pode ser desfeita.');
            if (confirmacao) {
                if (subIndex !== null) {
                    appData.dissertacao.capitulos[capIndex].subcapitulos.splice(subIndex, 1);
                } else {
                    appData.dissertacao.capitulos.splice(capIndex, 1);
                }
                renderTotalidade();
            }
        }
        
        window.addDissertacaoItem = function(capIndex) {
            const titulo = prompt(capIndex === null ? 'Digite o t√≠tulo do novo cap√≠tulo:' : 'Digite o t√≠tulo do novo subcap√≠tulo:');
            if (titulo) {
                const newItem = {
                    id: Date.now(),
                    titulo: titulo,
                    concluido: false,
                };
                if (capIndex === null) {
                    newItem.subcapitulos = [];
                    appData.dissertacao.capitulos.push(newItem);
                } else {
                    appData.dissertacao.capitulos[capIndex].subcapitulos.push(newItem);
                }
                renderTotalidade();
            }
        }

        window.editItemTitle = function(element, capIndex, subIndex) {
            const item = (subIndex !== null) ? appData.dissertacao.capitulos[capIndex].subcapitulos[subIndex] : appData.dissertacao.capitulos[capIndex];
            const novoTitulo = prompt('Editar t√≠tulo:', item.titulo);
            if (novoTitulo && novoTitulo.trim() !== '') {
                item.titulo = novoTitulo.trim();
                element.textContent = item.titulo;
            }
        }
        
        // --- SISTEMA DE CONQUISTAS E NOTIFICA√á√ïES ---
        function countCompletedTasksToday() {
            const hoje = new Date().getDay();
            return appData.progresso.semana[hoje]?.tarefas?.length || 0;
        }

        function isDissertacaoCompleta() {
            return appData.dissertacao.capitulos.every(cap => cap.concluido);
        }
        
        function checkAndUnlockConquistas() {
            appData.conquistas.forEach(conquista => {
                if (!conquista.desbloqueada && conquista.check()) {
                    conquista.desbloqueada = true;
                    notificationQueue.push(`üèÜ Conquista Desbloqueada: ${conquista.nome}`);
                }
            });
            processNotificationQueue();
        }

        function processNotificationQueue() {
            if (isNotifying || notificationQueue.length === 0) {
                return;
            }
            isNotifying = true;
            const message = notificationQueue.shift();
            const notificationContainer = document.getElementById('notification-container');
            const notificationText = document.getElementById('notification-text');

            notificationText.textContent = message;
            notificationContainer.classList.add('show');

            setTimeout(() => {
                notificationContainer.classList.remove('show');
                setTimeout(() => {
                    isNotifying = false;
                    processNotificationQueue();
                }, 500); // Espera a anima√ß√£o de sa√≠da
            }, 5000); // Tempo que a notifica√ß√£o fica vis√≠vel
        }


        // Iniciar o App
        init();
    });
    </script>
</body>
</html>
